(()=>{var ue=["black","darkslategray","darkolivegreen","saddlebrown","darkred","olive","darkslateblue","cadetblue","green","mediumseagreen","steelblue","chocolate","yellowgreen","indianred","darkblue","limegreen","goldenrod","darkseagreen","purple","maroon3","red","darkturquoise","darkorange","gold","yellow","mediumblue","burlywood","lime","mediumspringgreen","blueviolet","crimson","deepskyblue","greenyellow","tomato","orchid","lightsteelblue","fuchsia","khaki","cornflower","plum","deeppink","mediumslateblue","lightsalmon","paleturquoise","palegreen","aquamarine","lightgoldenrod","hotpink","lightpink","lavenderblush"];var k=class{static id;get mytype(){return this.constructor}get typename(){return this.mytype.id}toJSON(){return{t:this.typename}}static fromJSON(e,t){return new e}};function W(o){let e=b[o.t];return e.fromJSON(e,o)}var b={};function u(o,e){b[e]=o,o.id=e}var A=class extends k{cellName="";ship;onEnter(e){}};function ce(o){return o.prototype instanceof A}var P=class extends A{},E=class extends P{onEnter(e){p("Airlock_Locked").style.display=e.playerShip.toPlanet==e.playerShip.onPlanet?"":"none",p("Airlock_UnLocked").style.display=e.playerShip.toPlanet==e.playerShip.onPlanet?"none":"",p("Airlock_Detach").onclick=()=>{e.depart()}}};u(E,"Airlock");var J=class extends P{};u(J,"Passage");var y=class extends P{opposite="";onEnter(e){document.querySelector("#Ballast b").innerText=this.opposite||""}};u(y,"Ballast");var ae=class o extends P{original="";toJSON(){return{t:this.typename,o:this.original}}static fromJSON(e,t){let r=new o;return r.original=t.o,r}};u(ae,"Debris");var x=class extends A{},D=class o extends x{cargo=[];toJSON(){return{t:this.typename,c:this.cargo.map(e=>e.toJSON())}}static fromJSON(e,t){let r=new o;return r.cargo=t.c.map(n=>W(n)),r}onEnter(e){document.querySelector("#CargoBay ul").innerHTML=this.cargo.map(t=>`<li>${t.typename}</li>`).join(""),document.getElementById("CargoBay_Empty").style.display=this.cargo.length==0?"":"none",document.getElementById("CargoBay_NonEmpty").style.display=this.cargo.length==0?"none":""}};u(D,"CargoBay");function V(o){return o instanceof D}var M=class extends x{onEnter(e){let r=document.querySelector("#Radar canvas").getContext("2d");fe()}};u(M,"Radar");function fe(o){let e=document.querySelector("#Radar canvas");if(e.offsetParent===null)return;let t=e.getContext("2d");i.tick(o)&&window.requestAnimationFrame(fe),ye(t,i.star);let r=i.walkManager.walker.map.map[i.walkManager.walker.x][i.walkManager.walker.y].ship;r!==void 0&&de(t,i.star.ships,r.componentTypes[M.id])}var v=class extends x{};u(v,"Cloak");var _=class extends x{},H=class extends _{planetTr(e){let t=e.planet,r=e.i;if(t==i.playerShip.onPlanet)return"";let n=Math.ceil(t.distanceTo(i.playerShip)/.1),a=t==i.playerShip.toPlanet?"checked":"";return`<tr><td>
            <label for="NavigationComputer_to_${r}"><canvas id="NavigationComputer_canvas_${r}" width=30 height=30></canvas></label>
        </td><td>
            <label><input type="radio" name="NavigationComputer_to" value="${r}" id="NavigationComputer_to_${r}" ${a}>
            <b>${t.name}</b> (${n}d)<br>
            ${t.buys?`wants: ${t.buys.id}`:""} ${t.sells?`gives: ${t.sells.id}`:""}
        </label></td></tr>`}showDiv(e){p("currentComponentPage").innerHTML=`#NavigationComputer_${e}{display:block !important}`}onEnter(e){if(e.timeFlies){this.showDiv("Flying");return}this.showDiv("Select"),document.querySelector("#NavigationComputer table").innerHTML=e.star.planets.map((t,r)=>({planet:t,i:r,dist:t.distanceTo(e.playerShip)})).sort((t,r)=>t.dist-r.dist).map(this.planetTr).join(""),e.star.planets.forEach((t,r)=>{let n=document.getElementById(`NavigationComputer_canvas_${r}`);if(!n)return;let a=n.getContext("2d");ie(a,t,n.width/.2/2,n.width/2,n.height/2)}),p("NavigationComputer_Plot").style.display=this.ship instanceof c?"none":"",p("NavigationComputer_Fly").style.display=this.ship instanceof c?"":"none",p("NavigationComputer_Plot").onclick=()=>{let t=document.querySelector('input[name="NavigationComputer_to"]:checked');return!t||!e.playerShip.onPlanet?!1:(e.playerShip.planTrip(e.playerShip.onPlanet,e.star.planets[parseInt(t.value)],e.now),this.showDiv("Detach"),!0)},p("NavigationComputer_Fly").onclick=()=>{if(!p("NavigationComputer_Plot").onclick())return!1;this.showDiv("Departed"),e.depart()}}};u(H,"NavigationComputer");var I=class extends _{showDiv(e){p("currentComponentPage").innerHTML=`#TradingComputer_${e}{display:block !important}`}onEnter(e){let t=e.playerShip.onPlanet;if(t===null){this.showDiv("None");return}if(e.playerShip.countCargo(),t.buys===null){let n=Math.min(e.playerShip.freeCargo,t.ratio);if(n==0){this.showDiv("NoGift");return}this.showDiv("Gift"),p("TradingComputer_gift_number").innerText=n.toString(),p("TradingComputer_gift_type").innerText=t.sells.id,p("TradingComputer_gift_take").onclick=()=>{e.playerShip.putCargo(t.sells,n),this.showDiv("Done")};return}if(e.playerShip.cargoTypes[t.buys.id]<1){this.showDiv("NothingToTradde");return}this.showDiv("Trade");let r=p("TradingComputer_give_slider");p("TradingComputer_give_type").innerText=t.buys.id,p("TradingComputer_get_type").innerText=t.sells.id,r.value=r.max=e.playerShip.cargoTypes[t.buys.id].toString(),r.style.display=e.playerShip.cargoTypes[t.buys.id]==1?"none":"",r.onchange=()=>{let n=parseInt(r.value),a=Math.round(n*t.ratio);p("TradingComputer_max_cargo_warning").style.display=a-n>e.playerShip.freeCargo?"":"none",a=Math.min(a,e.playerShip.freeCargo+n),p("TradingComputer_give_number").innerText=n.toString(),p("TradingComputer_get_number").innerText=a.toString()},r.onchange(),p("TradingComputer_deal").onclick=()=>{let n=parseInt(r.value),a=Math.round(n*t.ratio);a=Math.min(a,e.playerShip.freeCargo+n),e.playerShip.getCargo(t.buys,n),e.playerShip.putCargo(t.sells,a),this.showDiv("Done")}}};u(I,"TradingComputer");var l=50,f=5;function ke(o,e,t,r,n,a){r.isAlien?o.rect(e*l,t*l+f,l,l-2*f):o.rect(e*l+f,t*l,l-2*f,l),o.strokeStyle="white",o.fillStyle="white",o.stroke(),o.textBaseline="top",o.fillText(n.cellName||"",e*l+f,t*l);let s=n.typename[0];n instanceof _&&(s+="C"),n instanceof v&&(s+="l"),o.fillText(s,e*l+f,t*l+16),a&&(a.map[e][t].canBeHere=!0,a.map[e][t].canGoX=r.isAlien,a.map[e][t].canGoY=!r.isAlien,a.map[e][t].ship=r,a.map[e][t].component=n)}function Pe(o,e,t,r,n){let a=r.passage;if(o.rect((e+a.x)*l,(t+a.y)*l,a.w*l,a.h*l),o.strokeStyle="white",o.fillStyle="white",o.stroke(),o.textBaseline="top",n){let s=new J;for(let m=0;m<a.w;m++)for(let h=0;h<a.h;h++)n.map[m+e][h+t].canBeHere=!0,n.map[m+e][h+t].canGoX=!0,n.map[m+e][h+t].canGoY=!0,n.map[m+e][h+t].ship=r,n.map[m+e][h+t].component=s}}function ge(o,e,t,r){o.strokeStyle="white",o.strokeStyle="white",o.fillStyle="white",o.beginPath(),o.moveTo(e*l+f,t*l),o.lineTo(e*l+f*2,(t+.5)*l),o.lineTo(e*l+f,(t+1)*l),o.lineTo((e+1)*l-f,(t+1)*l),o.lineTo((e+1)*l-f*2,(t+.5)*l),o.lineTo((e+1)*l-f,t*l),o.closePath(),o.stroke(),r&&(r.map[e][t].canBeHere=!0,r.map[e][t].canGoY=!0,r.map[e][t].component=new E)}function K(o,e,t,r,n){for(let a=0;a<r.rows.length;a++)for(let s=0;s<r.rows[a].length;s++){let m=r.rows[a][s],h=r.rowToXY(a,s);m.cellName=String.fromCharCode(65+a)+h.y,ke(o,e+h.x,t-h.y,r,m,n)}Pe(o,e,t,r,n)}function De(o,e,t,r){let n=e.x*t,a=e.y*t;if(o.fillStyle=e.color,o.fillRect(n-1,a-1,3,3),r!==void 0&&e instanceof c)for(let s=1;s<=r;s++)o.beginPath(),o.arc(n,a,t*s,0,7),o.strokeStyle="red",o.stroke()}function ie(o,e,t,r,n){r===void 0&&(r=e.x*t),n===void 0&&(n=e.y*t);var a=o.createRadialGradient(r-1,n-1,2,r,n,.2*t);a.addColorStop(0,e.color_in),a.addColorStop(1,e.color_out),o.fillStyle=a,o.beginPath(),o.arc(r,n,.2*t,0,7),o.fill()}function ye(o,e){let t=o.canvas.width,r=t/e.size,n=t/2;if(o.clearRect(0,0,t,t),e.bright){let a=o.createRadialGradient(n,n,0,n,n,r/2);a.addColorStop(0,"white"),a.addColorStop(.5,e.color),a.addColorStop(1,"transparent"),o.fillStyle=a,o.fillRect(0,0,t,t)}else{let a=o.createRadialGradient(n,n,10,n,n,r/2);a.addColorStop(0,e.color),a.addColorStop(1,"transparent"),o.fillStyle=a,o.fillRect(0,0,t,t)}for(let a of e.planets)ie(o,a,r)}function de(o,e,t){let n=o.canvas.width/i.star.size;for(let a of e)(a instanceof c||a.seenBy(i.playerShip,t))&&De(o,a,n,t)}function $(o){p("now-day").innerText=(o+1).toString();let e=Math.floor(o/300)+3e3,t=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov"][Math.floor(o%300/30)],r=Math.floor(o%30)+1;p("now-date").innerText=`${r} ${t} ${e}`}var T=class extends k{};function Se(o){return o.prototype instanceof T}var U=class extends T{},se=class extends U{};u(se,"Rocket");var le=class extends U{};u(le,"Fuel");var C=class extends T{},O=class extends C{static color="blue"};u(O,"Water");var z=class extends C{static color="yellow"};u(z,"Iron");var F=class extends C{static color="green"};u(F,"Food");var j=class extends C{static color="red"};u(j,"Radioactives");function Me(o,e){let t=Math.hypot(o,e);return[o/t,e/t]}function _e(o,e){return o[0]*e[0]+o[1]*e[1]}function Be(o,e,t){let r=Me(o.x-e.x,o.y-e.y),n=_e(r,[t.x-e.x,t.y-e.y]);return[e.x+r[0]*n,e.y+r[1]*n]}function pe(o,e,t,r){let[n,a]=Be(o,e,t);return n>=Math.min(o.x,e.x)&&n<=Math.max(o.x,e.x)&&a>=Math.min(o.y,e.y)&&a<=Math.max(o.y,e.y)&&Math.hypot(n-t.x,a-t.y)<r}function d(o,e){return o>e&&([o,e]=[e,o]),Math.floor(Math.random()*(e-o+1))+o}function R(o){return o[Math.floor(Math.random()*o.length)]}function N(o){return o.map(e=>({sort:Math.random(),value:e})).sort((e,t)=>e.sort-t.sort).map(e=>e.value)}function L(o){return[...Array(o).keys()]}var g=class o{color;isAlien=!1;rows=[];offsets=[];componentTypes;cargoTypes;freeCargo;isPlayerShip=!1;playerOnShip=!1;playerX;playerY;x;y;fromPoint;toPlanet;fromTime;toTime;updateSpaceXY(e,t=!0){for(;e>=this.toTime&&t;)this.toPlanet.dispatch(this,this.toTime);let r=(e-this.fromTime)/(this.toTime-this.fromTime);this.x=this.fromPoint.x+(this.toPlanet.x-this.fromPoint.x)*r,this.y=this.fromPoint.y+(this.toPlanet.y-this.fromPoint.y)*r}planTrip(e,t,r){this.fromPoint=e,this.toPlanet=t,this.fromTime=r;let a=t.distanceTo(e)/.1;this.toTime=r+a,this.updateSpaceXY(this.fromTime)}countComponents(){this.componentTypes={};let e=Object.values(b).filter(ce).forEach(r=>this.componentTypes[r.id]=0),t=this.rows.flat();for(let r of t)this.componentTypes[r.typename]++}countCargo(){let e=this.rows.flat().filter(V);this.freeCargo=0,this.cargoTypes={},Object.values(b).filter(Se).forEach(t=>this.cargoTypes[t.id]=0);for(let t of e){this.freeCargo+=4-t.cargo.length;for(let r of t.cargo)this.cargoTypes[r.typename]++}}addComponent(e,t){e.ship=this,this.rows[t].push(e)}getCargo(e,t){if(t>this.cargoTypes[e.id])return!1;this.cargoTypes[e.id]-=t,this.freeCargo+=t;let r=this.rows.flat().filter(V).filter(n=>n.cargo.length);for(let n of r)if(n.cargo=n.cargo.filter(a=>!(a instanceof e&&t-- >0)),t<=0)return!0}putCargo(e,t){if(t>this.freeCargo)return!1;this.cargoTypes[e.id]+=t,this.freeCargo-=t;let r=this.rows.flat().filter(V).filter(n=>n.cargo.length<4);for(let n of r){for(;t>0&&n.cargo.length<4;)n.cargo.push(new e),t--;if(t<=0)return!0}}seenBy(e,t){let r=Math.hypot(e.x-this.x,e.y-this.y);return t>=r+this.componentTypes[v.id]}toJSON(){return{a:this.isAlien,c:this.color,o:this.offsets,r:this.rows.map(e=>e.map(t=>t.toJSON())),frX:this.fromPoint.x,frY:this.fromPoint.y,frT:this.fromTime,toP:this.toPlanet.i,toT:this.toTime}}static fromJSON(e,t,r){r||(r=new o),r.isAlien=e.a,r.color=e.c,r.offsets=e.o,r.rows=[];for(let n=0;n<e.r.length;n++){r.rows[n]=[];for(let a=0;a<e.r[n].length;a++)r.addComponent(W(e.r[n][a]),n)}return r.fromPoint={x:e.frX,y:e.frY},r.fromTime=e.frT,r.toPlanet=t.planets[e.toP],r.countComponents(),r}get gridSize(){if(this.isAlien)return{x0:0,x1:0,y0:0,y1:0,w:0,h:0};{let e=0,t=0;for(let r=0;r<this.rows.length;r++)e=Math.max(e,this.rows[r].length-this.offsets[r]),t=Math.max(t,this.offsets[r]);return{x0:0,x1:this.rows.length-1,y0:e,y1:t,w:this.rows.length,h:e+t+1}}}rowToXY(e,t){return this.isAlien?{x:0,y:0}:t>=this.offsets[e]?{x:e,y:1+(t-this.offsets[e])}:{x:e,y:t-this.offsets[e]}}get passage(){return this.isAlien?{x:0,y:0,w:0,h:0}:{x:0,y:0,w:this.rows.length,h:1}}oppositeComponent(e){for(let t=0;t<=this.rows.length;t++){let r=this.rows[t].indexOf(e);if(r>=0)return this.rows[this.rows.length-1-t][r]}}static randomShip(e,t){let n=Object.values(b).filter(s=>s.prototype instanceof x),a=Object.values(b).filter(s=>s.prototype instanceof T);t===void 0&&(t=new o),t.color=R(ue),t.rows=[[],[],[],[]],t.offsets=[0,0,0,0];for(let s=0;s<e;s++){let m=R(n),h=new m;if(h instanceof D){let ne=d(0,4);for(let q=0;q<ne;q++){let Te=R(a);h.cargo.push(new Te)}}t.addComponent(h,d(0,3))}for(let s=0;s<t.rows.length;s++)t.offsets[s]=d(0,t.rows[s].length);return t.balanceBallast(),t.countComponents(),t}static newBase(e){let t=new o;return t.color="black",t.rows=[[],[]],t.addComponent(new H,d(0,1)),t.addComponent(new M,d(0,1)),t.addComponent(new I,d(0,1)),t.offsets=[d(0,t.rows[0].length),d(0,t.rows[1].length)],t.balanceBallast(),t.countComponents(),t}balanceBallast(){if(!this.isAlien){let r=this.rows.length-1;for(var e=0;e<=r;e++)for(;this.offsets[e]<this.offsets[r-e];)this.rows[e].unshift(new y),this.offsets[e]++;for(var e=0;e<=r;e++)for(;this.rows[e].length<this.rows[r-e].length;)this.rows[e].push(new y);for(var e=0;e<=r;e++)for(;this.rows[e][0]instanceof y&&this.rows[r-e][0]instanceof y;)this.rows[e].shift(),this.rows[r-e].shift(),this.offsets[e]--,this.offsets[r-e]++;for(var e=0;e<=r;e++)for(;this.rows[e].at(-1)instanceof y&&this.rows[r-e].at(-1)instanceof y;)this.rows[e].pop(),this.rows[r-e].pop();for(var e=0;e<=r;e++)for(var t=0;t<=this.rows[e].length;t++)this.rows[e][t]instanceof y&&(this.rows[e][t].opposite=this.rows[r-e][t].typename)}}get topAirlock(){if(this.isAlien)return 0;{let e=0;for(let t=0;t<this.rows.length;t++)e=Math.max(e,this.rows[t].length-this.offsets[t]);for(let t=0;t<this.rows.length;t++)if(this.rows[t].length-this.offsets[t]==e)return t;return 0}}get bottomAirlock(){if(this.isAlien)return 0;{let e=Math.max(...this.offsets);return this.offsets.lastIndexOf(e)}}};var we=function(){let o=[O,z,F,j];for(var e=[[null,"water-mining","farming","burning"],["ice",null,"hunting","fire"],["fishy","bio-mining",null,"nuclear"],["frozen","hot mining","ice-farming",null]],t=[["ocean",null,O,"navy","blue"]],r=0;r<4;r++)for(var n=0;n<4;n++)r!=n&&t.push([e[r][n],o[r],o[n],o[r].color,o[n].color]);return t}(),Q=class{x;y;i;type;name;buys;sells;ratio;color_in;color_out;neighbours;base;constructor(e,t,r,n){var a=we[r];this.x=e,this.y=t,this.i=n,this.type=r,this.name=a[0],this.buys=a[1],this.sells=a[2],this.color_in=a[3],this.color_out=a[4],this.base=g.newBase(this)}distanceTo(e){return Math.hypot(this.x-e.x,this.y-e.y)}toJSON(){return[this.x,this.y,this.type]}dispatch(e,t){let r=this.neighbours.shift();this.neighbours.push(r),e.planTrip(this,r,t)}};function Oe(o,e,t){var r=t/2;return o<r+.6&&o>r-.6&&e<r+.6&&e>r-.6}function be(o){for(var e=N(L(we.length)),t=0;t<100;t++){for(var r=!1,n=[],a=N(L(o)),s=N(L(o)),m=o/2,h=0;h<o;h++)Oe(a[h]+.5,s[h]+.5,o)&&(r=!0),n.push([a[h]+.5,s[h]+.5,e[h]]);if(!r)return n}return console.error("should not be here"),[]}var Re=["AliceBlue","AntiqueWhite","Aqua","Aquamarine","Azure","Beige","Bisque","BlanchedAlmond","Blue","BlueViolet","Brown","BurlyWood","CadetBlue","Chartreuse","Chocolate","Coral","CornflowerBlue","Cornsilk","Crimson","Cyan","DarkGray","DarkGrey","DarkKhaki","DarkOrange","DarkOrchid","DarkSalmon","DarkSeaGreen","DarkTurquoise","DarkViolet","DeepPink","DeepSkyBlue","DimGray","DodgerBlue","FireBrick","FloralWhite","Fuchsia","Gainsboro","GhostWhite","Gold","Goldenrod","Gray","GreenYellow","Grey","Honeydew","HotPink","IndianRed","Ivory","Khaki","Lavender","LavenderBlush","LawnGreen","LemonChiffon","LightBlue","LightCoral","LightCyan","LightGoldenrodYellow","LightGray","LightGreen","LightGrey","LightPink","LightSalmon","LightSeaGreen","LightSkyBlue","LightSlateGray","LightSlateGrey","LightSteelBlue","LightYellow","Lime","LimeGreen","Linen","Magenta","MediumAquamarine","MediumBlue","MediumOrchid","MediumPurple","MediumSeaGreen","MediumSlateBlue","MediumSpringGreen","MediumTurquoise","MediumVioletRed","MintCream","MistyRose","Moccasin","NavajoWhite","OldLace","Orange","OrangeRed","Orchid","PaleGoldenrod","PaleGreen","PaleTurquoise","PaleVioletRed","PapayaWhip","PeachPuff","Peru","Pink","Plum","PowderBlue","Red","RosyBrown","RoyalBlue","Salmon","SandyBrown","Seashell","Sienna","Silver","SkyBlue","SlateBlue","SlateGray","SlateGrey","Snow","SpringGreen","SteelBlue","Tan","Thistle","Tomato","Turquoise","Violet","Wheat","White","WhiteSmoke","Yellow","YellowGreen"];function Ne(o,e){for(var t=L(e).map(s=>[]),r=(e-1)/2,n=Math.floor(r);n<=Math.ceil(r);n++)for(var a=Math.floor(r);a<=Math.ceil(r);a++)t[n+1][a+1]=o;return t}var G=class{color;size;bright;name;grid;planets;ships;constructor(e){e||(e={c:R(Re),sz:d(5,9),p:!1,sh:!1}),this.color=e.c,this.size=e.sz,this.bright=!1,this.name=this.color,this.size%2==0&&(this.bright=!0,this.name="bright "+this.name),this.grid=Ne(this,this.size),e.p||(e.p=be(this.size)),this.planets=e.p.map((r,n)=>new Q(...r,n));for(var t of this.planets)t.neighbours=N(this.planets.filter(r=>r!=t&&!this.pathCollides(r,t))),this.grid[Math.floor(t.x)][Math.floor(t.y)]=t;e.sh&&(this.ships=e.sh.map(r=>r.p?c.fromJSON(r,this):g.fromJSON(r,this))),this.setRatios()}pathCollides(e,t){if(pe(e,t,{x:this.size/2,y:this.size/2},.5))return!0;for(var r of this.planets)if(r!=e&&r!=t&&pe(e,t,r,.2))return!0;return!1}computeRareResources(e){e===void 0&&(e=this.planets);let t=e.map(a=>a.sells),r=Object.values(b).filter(a=>a instanceof C&&!t.includes(a)),n=e.filter(a=>a.buys===null).map(a=>a.sells);return{exotic:r,abundant:n}}setRatios(){let e=this.computeRareResources();for(let t of this.planets)t.buys===null?t.ratio=2:e.abundant.includes(t.buys)?t.ratio=1:e.exotic.includes(t.buys)?t.ratio=2:t.ratio=1.4}addRandomShips(e){this.ships=[];for(let t=0;t<this.planets.length;t++)for(let r=0;r<t;r++){if(this.planets[t].neighbours.indexOf(this.planets[r])<0)continue;let n=g.randomShip(15),s=Math.hypot(this.planets[t].x-this.planets[r].x,this.planets[t].y-this.planets[r].y)/.1;this.planets[t].dispatch(n,e-s),this.ships.push(n)}}toJSON(){return{c:this.color,sz:this.size,p:this.planets.map(e=>e.toJSON()),sh:this.ships.map(e=>e.toJSON())}}};var ee=class o{star;playerShip;walkManager;walkCTX;now=0;lastTickTimestamp;lastDate;_timeFlies=!1;tickInterval=0;get timeFlies(){return this._timeFlies}set timeFlies(e){if(this._timeFlies!=e)if(this._timeFlies=e,e){let t=this;this.lastTickTimestamp=performance.now(),this.tickInterval=setInterval(function(){t.tick()},1e3)}else clearInterval(this.tickInterval)}tick(e){if(!this._timeFlies)return!1;if(e||(e=performance.now()),e<=this.lastTickTimestamp)return!0;this.now+=Math.max(0,Math.min(e-this.lastTickTimestamp,1e3))/1e3,this.lastTickTimestamp=e;let t=Math.floor(this.now);if(this.lastDate!=t){$(t),this.lastDate=t;let r=Math.ceil(this.playerShip.toTime-this.now);he(`Approaching ${this.playerShip.toPlanet.name} planet in ${r} days`)}for(let r of this.star.ships)r.updateSpaceXY(this.now);return!0}depart(){this.timeFlies=!0,this.playerShip.onPlanet=null,this.walkManager.detach(this.walkCTX),this.lastDate=-1,this.tick()}arrive(){this.playerShip.onPlanet=this.playerShip.toPlanet,this.playerShip.x=this.playerShip.onPlanet.x,this.playerShip.y=this.playerShip.onPlanet.y,this.timeFlies=!1,this.walkManager.attach(this.walkCTX,this.playerShip.onPlanet.base),he(`Docked to base at ${this.playerShip.onPlanet.name} planet`),localStorage.space2d3_2=JSON.stringify(this.toJSON())}toJSON(){return{s:this.star.toJSON(),n:this.now}}static fromJSON(e){let t=new o;t.star=new G(e.s);let r=t.star.ships.filter(Ce);if(r.length!=1)debugger;return t.playerShip=r[0],t.now=e.n,t}};function xe(o){i=ee.fromJSON(o)||i}var i=new ee;var c=class o extends g{onPlanet;updateSpaceXY(e){super.updateSpaceXY(e,!1),e>=this.toTime&&i.arrive()}static randomShip(e){let t=new o;return g.randomShip(e,t),t.color="white",t}toJSON(){let e=super.toJSON();return e.p=!0,this.onPlanet!=null&&(e.on=this.onPlanet.i),e}static fromJSON(e,t){let r=new o;return g.fromJSON(e,t,r),r}};function Ce(o){return o instanceof c}var me=class{canBeHere=!1;canGoX=!1;canGoY=!1;ship;component},X=class{map=[];constructor(e,t){for(let r=0;r<=e;r++){this.map[r]=[];for(let n=0;n<=t;n++)this.map[r][n]=new me}}},te=class{x;y;map;box;human;canvas;onEnter;goX(e){return!this.map.map[this.x][this.y].canGoX||!this.map.map[this.x+e][this.y].canBeHere?!1:(this.x+=e,this.reposition(),this.onEnter(this.map.map[this.x][this.y].component),!0)}goY(e,t){return!t&&!this.map.map[this.x][this.y].canGoY||!this.map.map[this.x][this.y+e].canBeHere?!1:(this.y+=e,this.reposition(),this.onEnter(this.map.map[this.x][this.y].component),!0)}goUp(){this.goY(-1),this.human.style.transform="rotate(0deg)"}goDn(e){this.goY(1,e),this.human.style.transform="rotate(180deg)"}goLt(){this.goX(-1),this.human.style.transform="rotate(-90deg)"}goRt(){this.goX(1),this.human.style.transform="rotate(90deg)"}jumpTo(e,t,r=!0){this.x=e,this.y=t,this.reposition(!0),r&&this.onEnter(this.map.map[e][t].component)}reposition(e){e&&this.canvas.classList.add("notransition");let t=(this.x+.5)*l,n=this.box.offsetWidth/2-t;this.canvas.style.left=n+"px";let a=(this.y+.5)*l,m=this.box.offsetHeight/2-a;this.canvas.style.top=m+"px",e&&(this.canvas.offsetHeight,this.canvas.classList.remove("notransition"))}};var re=class{walker;oneShipData;twoShipsData;hasSecondShip=!1;myShip;secondShip;putTwoShips(e,t){let r=e.gridSize,n=t.gridSize,a=e.bottomAirlock,s=t.topAirlock,m=Math.max(a,s)+1,h=r.h+1,ne=m+Math.max(r.w-a,n.w-s),q=h+n.h+1;this.myShip=t,this.secondShip=e,this.hasSecondShip=!0,this.twoShipsData={ax0:m-a+r.x0,ay0:r.y0+1,airlock_x:m,airlock_y:h,bx0:m-s+n.x0,by0:h+n.y0+1,max_x:ne,max_y:q}}drawTwoShips(e,t,r){this.putTwoShips(t,r);let n=this.twoShipsData,a=new X(n.max_x,n.max_y);this.walker.map=a,e.canvas.width=l*(n.max_x+1),e.canvas.height=l*(n.max_y+1),K(e,n.ax0,n.ay0,t,a),K(e,n.bx0,n.by0,r,a),ge(e,n.airlock_x,n.airlock_y,a)}drawMyShip(e){this.hasSecondShip=!1;let t=this.oneShipData=this.myShip.gridSize,r=this.walker.map=new X(t.w+1,t.h+1);e.canvas.width=l*(t.w+2),e.canvas.height=l*(t.h+2),K(e,t.x0+1,t.y0+1,this.myShip,r)}detach(e){if(!this.hasSecondShip)return!1;let t=!1;if(this.walker.y==this.twoShipsData.airlock_y&&(this.walker.y++,t=!0),this.secondShip.playerOnShip=this.walker.y<this.twoShipsData.airlock_y,this.myShip.playerOnShip=this.walker.y>this.twoShipsData.airlock_y,!(this.walker.y<this.twoShipsData.airlock_y)){let r=this.myShip.playerX=this.walker.x-this.twoShipsData.bx0,n=this.myShip.playerY=this.walker.y-this.twoShipsData.by0;this.drawMyShip(e),t?(this.walker.jumpTo(this.oneShipData.x0+1+r,this.oneShipData.y0+n,!1),this.walker.goDn(!0)):this.walker.jumpTo(this.oneShipData.x0+1+r,this.oneShipData.y0+1+n,!1)}}attach(e,t){if(this.hasSecondShip)return!1;let r=this.walker.x-1-this.oneShipData.x0,n=this.walker.y-1-this.oneShipData.y0;this.drawTwoShips(e,t,this.myShip),this.walker.jumpTo(this.twoShipsData.bx0+r,this.twoShipsData.by0+n)}};function p(o){let e=document.getElementById(o);if(!e)throw ReferenceError(`element ${o} not found`);return e}function tr(o){let e=p(o);if(!(e instanceof HTMLInputElement))throw ReferenceError(`element ${o} is not input`);return e}(location.hostname=="localhost"||location.hostname=="127.0.0.1")&&new EventSource("/esbuild").addEventListener("change",()=>location.reload());var w=new te,S=new re;S.walker=w;var ve=p("myCanvas"),oe=ve.getContext("2d");w.box=p("canvasBox");w.human=p("human");w.canvas=ve;w.onEnter=Ae;function Le(){i.star=new G,i.star.addRandomShips(0),i.playerShip=c.randomShip(15),i.star.ships.push(i.playerShip),S.myShip=i.playerShip,S.drawMyShip(oe),w.jumpTo(S.oneShipData.x0+1,S.oneShipData.y0+1),i.playerShip.planTrip({x:i.star.planets[0].x-.1,y:i.star.planets[0].y},i.star.planets[0],-1),i.now=0,i.walkManager=S,i.walkCTX=oe,i.arrive(),$(i.now),window.gs=i}function Ge(){xe(JSON.parse(localStorage.space2d3_2)),S.myShip=i.playerShip,S.drawMyShip(oe),w.jumpTo(S.oneShipData.x0+1,S.oneShipData.y0+1),i.walkManager=S,i.walkCTX=oe,i.arrive(),$(Math.floor(i.now)),window.gs=i}localStorage.space2d3_2?Ge():Le();window.onkeypress=o=>{switch(o.key){case"w":w.goUp();break;case"a":w.goLt();break;case"s":w.goDn();break;case"d":w.goRt();break}};function Ae(o){o&&(p("currentComponent").innerHTML=`#${o.typename} {display:block}`,o.cellName?p("componentLegend").innerText=`${o.cellName}: ${o.typename}`:p("componentLegend").innerText=`${o.typename}`,o.onEnter(i))}function he(o){p("status").innerText=o}})();
//# sourceMappingURL=script.js.map
