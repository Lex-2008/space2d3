(()=>{function we(i){let e=parseInt(i,16),t=e>>16&255,o=e>>8&255,r=e&255,n=t/255,a=o/255,p=r/255;n>.04045?n=Math.pow((n+.055)/1.055,2.4):n=n/12.92,a>.04045?a=Math.pow((a+.055)/1.055,2.4):a=a/12.92,p>.04045?p=Math.pow((p+.055)/1.055,2.4):p=p/12.92,n=n*100,a=a*100,p=p*100;let d=(n*.2126+a*.7152+p*.0722)/100;return d>.008856?d=Math.pow(d,1/3):d=7.787*d+16/116,116*d-16}function ue(i){let e=(i+16)/116,t=e,o=e,r=95.047,n=100,a=108.883,[p,c,x]=[t,e,o].map(j=>Math.pow(j,3)>.008856?Math.pow(j,3):(j-16/116)/7.787);p*=r,c*=n,x*=a,t=p/100,e=c/100,o=x/100;let d=t*3.2406+e*-1.5372+o*-.4986,v=d>.0031308?1.055*Math.pow(d,1/2.4)-.055:12.92*d;return v=Math.round(v*255),(1<<24|v<<16|v<<8|v).toString(16).slice(1)}function b(i,e){return i>e&&([i,e]=[e,i]),Math.floor(Math.random()*(e-i+1))+i}function g(i){return i[Math.floor(Math.random()*i.length)]}function M(i){return i.map(e=>({sort:Math.random(),value:e})).sort((e,t)=>e.sort-t.sort).map(e=>e.value)}function P(i){return[...Array(i).keys()]}function l(i){let e=document.getElementById(i);if(!e)throw ReferenceError(`element ${i} not found`);return e}function ye(i){l("status").innerText=i}function ie(i){l("now-day").innerText=(i+1).toString();let e=Math.floor(i/300)+3e3,t=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov"][Math.floor(i%300/30)],o=Math.floor(i%30)+1;l("now-date").innerText=`${o} ${t} ${e}`}function re(i){let e=we(i);return e<50?ue(Math.min(e+50,100)):ue(Math.max(e-50,0))}function W(i,e,...t){if(!i)throw t.length&&console.error(e,...t),new Error(e)}var I=class{static id;get mytype(){return this.constructor}get typename(){return this.mytype.id}toJSON(){return{t:this.typename}}static fromJSON(e,t){return new e}};function ne(i){let e=f[i.t];return e.fromJSON(e,i)}var f={};function m(i,e){f[e]=i,i.id=e}var A=class extends I{static symbol;toText(){return`${this.mytype.symbol||""} ${this.typename}`}};function Z(i){return i.prototype instanceof A}var se=class extends A{},k=class extends se{static symbol="\u{1F680}"};m(k,"Rocket");var D=class extends se{static symbol="\u{1F6E2}\uFE0F"};m(D,"Fuel");var H=class extends A{};var N=class extends H{static color="blue";static symbol="\u{1F4A7}\uFE0F"};m(N,"Water");var F=class extends H{static color="yellow";static symbol="\uFE0F\u26CF\uFE0F"};m(F,"Iron");var z=class extends H{static color="green";static symbol="\uFE0F\u{1F96B}"};m(z,"Food");var q=class extends H{static color="red";static symbol="\uFE0F\u2622\uFE0F"};m(q,"Radioactives");var T=class extends A{static symbol="\uFE0F\u{1F4E6}\uFE0F";from;to;total;toText(){return`${this.mytype.symbol||""} ${this.typename} to <b>${this.to}</b> planet`}toJSON(){return{t:this.typename,f:this.from,to:this.to,tot:this.total}}static fromJSON(e,t){let o=new e;return o.from=t.f,o.to=t.to,o.total=t.tot,o}};m(T,"MissionBox");function ae(i){return i instanceof T}var de=["000000","2f4f4f","556b2f","8b4513","8b0000","808000","483d8b","5f9ea0","008000","3cb371","4682b4","d2691e","9acd32","cd5c5c","00008b","32cd32","daa520","8fbc8f","800080","b03060","ff0000","00ced1","ff8c00","ffd700","ffff00","0000cd","deb887","00ff00","00fa9a","8a2be2","dc143c","00bfff","adff2f","ff6347","da70d6","b0c4de","ff00ff","f0e68c","6495ed","dda0dd","ff1493","7b68ee","ffa07a","afeeee","98fb98","7fffd4","fafad2","ff69b4","ffb6c1","fff0f5"];function Fe(i,e){let t=Math.hypot(i,e);return[i/t,e/t]}function Ye(i,e){return i[0]*e[0]+i[1]*e[1]}function Je(i,e,t){let o=Fe(i.x-e.x,i.y-e.y),r=Ye(o,[t.x-e.x,t.y-e.y]);return[e.x+o[0]*r,e.y+o[1]*r]}function ge(i,e,t,o){let[r,n]=Je(i,e,t);return r>=Math.min(i.x,e.x)&&r<=Math.max(i.x,e.x)&&n>=Math.min(i.y,e.y)&&n<=Math.max(i.y,e.y)&&Math.hypot(r-t.x,n-t.y)<o}var h=50,u=5;function $e(i,e,t,o,r,n){i.beginPath(),o.isAlien?i.rect(e*h,t*h+u,h,h-2*u):i.rect(e*h+u,t*h,h-2*u,h),i.lineWidth=5,i.strokeStyle=o.color,i.fillStyle=o.color2,i.fill(),i.stroke(),i.textBaseline="top",i.fillStyle=o.color,i.fillText(r.cellName||"",e*h+u+5,t*h+5);let p=r.typename[0];r instanceof _&&(p+="C"),r instanceof U&&(p+="l"),i.fillText(p,e*h+u+5,t*h+5+16),n[e][t]={canBeHere:!0,canGoX:o.isAlien,canGoY:!o.isAlien,ship:o,component:r}}function Xe(i,e,t,o,r){let n=o.passage;i.beginPath(),i.rect((e+n.x)*h,(t+n.y)*h,n.w*h,n.h*h),i.strokeStyle=o.color,i.fillStyle=o.color2,i.fill(),i.stroke();let a=new K;for(let p=0;p<n.w;p++)for(let c=0;c<n.h;c++)r[p+e][c+t]={canBeHere:!0,canGoX:!0,canGoY:!0,ship:o,component:a}}function ve(i,e,t,o,r,n){let a=i.createLinearGradient(e*h+u,t*h,e*h+u,(t+1)*h),p=i.createLinearGradient(e*h+u,t*h,e*h+u,(t+1)*h);a.addColorStop(0,o.color),a.addColorStop(1,r.color),p.addColorStop(0,o.color2),p.addColorStop(1,r.color2),i.strokeStyle=a,i.fillStyle=p,i.beginPath(),i.moveTo(e*h+u,t*h),i.lineTo(e*h+u*2,(t+.5)*h),i.lineTo(e*h+u,(t+1)*h),i.lineTo((e+1)*h-u,(t+1)*h),i.lineTo((e+1)*h-u*2,(t+.5)*h),i.lineTo((e+1)*h-u,t*h),i.closePath(),i.fill(),i.stroke(),n[e][t]={canBeHere:!0,canGoY:!0,component:new V}}function le(i,e,t,o,r){for(let n=0;n<o.rows.length;n++)for(let a=0;a<o.rows[n].length;a++){let p=o.rows[n][a],c=o.rowToXY(n,a);p.cellName=String.fromCharCode(65+n)+c.y,$e(i,e+c.x,t-c.y,o,p,r)}Xe(i,e,t,o,r)}function je(i,e,t,o){let r=e.x*t,n=e.y*t;if(i.fillStyle=e.color,i.fillRect(r-1,n-1,3,3),o!==void 0&&e instanceof S)for(let a=1;a<=o;a++)i.beginPath(),i.arc(r,n,t*a,0,7),i.strokeStyle="red",i.stroke()}function Se(i,e,t,o,r){o===void 0&&(o=e.x*t),r===void 0&&(r=e.y*t);var n=i.createRadialGradient(o-1,r-1,2,o,r,.2*t);n.addColorStop(0,e.color_in),n.addColorStop(1,e.color_out),i.fillStyle=n,i.beginPath(),i.arc(o,r,.2*t,0,7),i.fill()}function Te(i,e){let t=i.canvas.width,o=t/e.size,r=t/2;if(i.clearRect(0,0,t,t),e.bright){let n=i.createRadialGradient(r,r,0,r,r,o/2);n.addColorStop(0,"white"),n.addColorStop(.5,e.color),n.addColorStop(1,"transparent"),i.fillStyle=n,i.fillRect(0,0,t,t)}else{let n=i.createRadialGradient(r,r,10,r,r,o/2);n.addColorStop(0,e.color),n.addColorStop(1,"transparent"),i.fillStyle=n,i.fillRect(0,0,t,t)}for(let n of e.planets)Se(i,n,o)}function Me(i,e,t){let o=i.canvas.width,r=o/s.star.size;i.clearRect(0,0,o,o);for(let n of e)(n instanceof S||n.seenBy(s.playerShip,t))&&je(i,n,r,t)}var Q=class extends I{cellName="";ship;onEnter(e){}};function _e(i){return i.prototype instanceof Q}var J=class extends Q{},V=class extends J{onEnter(e){l("Airlock_Locked").style.display=e.playerShip.toPlanet==e.playerShip.onPlanet?"":"none",l("Airlock_UnLocked").style.display=e.playerShip.toPlanet==e.playerShip.onPlanet?"none":"",l("Airlock_Detach").onclick=()=>{e.depart()}}};m(V,"Airlock");var K=class extends J{};m(K,"Passage");var C=class extends J{opposite="";onEnter(e){document.querySelector("#Ballast b").innerText=this.opposite||""}};m(C,"Ballast");var be=class i extends J{original="";toJSON(){return{t:this.typename,o:this.original}}static fromJSON(e,t){let o=new i;return o.original=t.o,o}};m(be,"Debris");var L=class extends Q{};function $(i){return i.prototype instanceof L&&!(i.prototype instanceof _)}var O=class i extends L{cargo=[];toJSON(){return{t:this.typename,c:this.cargo.map(e=>e.toJSON())}}static fromJSON(e,t){let o=new i;return o.cargo=t.c.map(r=>ne(r)),o}onEnter(e){document.querySelector("#CargoBay ul").innerHTML=this.cargo.map(t=>`<li>${t.toText()}</li>`).join(""),document.getElementById("CargoBay_Empty").style.display=this.cargo.length==0?"":"none",document.getElementById("CargoBay_NonEmpty").style.display=this.cargo.length==0?"none":""}};m(O,"CargoBay");function B(i){return i instanceof O}var E=class extends L{onEnter(e){let o=document.querySelector("#Radar canvas").getContext("2d");Be()}};m(E,"Radar");function Be(i){let e=l("shipsCanvas");if(e.offsetParent===null)return;let t=e.getContext("2d");s.tick(i)&&window.requestAnimationFrame(Be);let o=s.walker.map[s.walker.x][s.walker.y].ship;o!==void 0&&Me(t,s.star.ships,o.componentTypes[E.id])}var U=class extends L{};m(U,"Cloak");var _=class extends L{};function Pe(i){return i.prototype instanceof _&&!(i.prototype instanceof he)}var ee=class extends _{planetTr(e){let t=e.planet,o=e.i,r=Math.ceil(t.distanceTo(s.playerShip)/.1),n=t==s.playerShip.toPlanet?"checked":"",a=t==s.playerShip.onPlanet?"disabled":"";return`<tr><td>
            <label for="NavigationComputer_to_${o}"><canvas id="NavigationComputer_canvas_${o}" width=30 height=30></canvas></label>
        </td><td>
            <label><input type="radio" name="NavigationComputer_to" value="${o}" id="NavigationComputer_to_${o}" ${a} ${n}>
            <b>${t.name}</b> (${r}d)<br>
            ${t.buys?`wants: ${t.buys.id}`:""} ${t.sells?`gives: ${t.sells.id}`:""}
        </label></td></tr>`}showDiv(e){l("currentComponentPage").innerHTML=`#NavigationComputer_${e}{display:block !important}`}onEnter(e){if(e.timeFlies){this.showDiv("Flying");return}this.showDiv("Select"),document.querySelector("#NavigationComputer table").innerHTML=e.star.planets.map((t,o)=>({planet:t,i:o,dist:t.distanceTo(e.playerShip)})).sort((t,o)=>t.dist-o.dist).map(this.planetTr).join(""),e.star.planets.forEach((t,o)=>{let r=document.getElementById(`NavigationComputer_canvas_${o}`);if(!r)return;let n=r.getContext("2d");Se(n,t,r.width/.2/2,r.width/2,r.height/2)}),l("NavigationComputer_Plot").style.display=this.ship instanceof S?"none":"",l("NavigationComputer_Fly").style.display=this.ship instanceof S?"":"none",l("NavigationComputer_Plot").onclick=()=>{let t=document.querySelector('input[name="NavigationComputer_to"]:checked');return!t||!e.playerShip.onPlanet?!1:(e.playerShip.planTrip(e.playerShip.onPlanet,e.star.planets[parseInt(t.value)],e.now),this.showDiv("Detach"),!0)},l("NavigationComputer_Fly").onclick=()=>{if(!l("NavigationComputer_Plot")?.onclick?.())return!1;this.showDiv("Departed"),e.depart()}}};m(ee,"NavigationComputer");var te=class extends _{showDiv(e){l("currentComponentPage").innerHTML=`#TradingComputer_${e}{display:block !important}`}onEnter(e){let t=e.playerShip.onPlanet;if(t===null){this.showDiv("None");return}if(e.playerShip.countCargo(),t.buys===null){let r=Math.min(e.playerShip.freeCargo,t.ratio);if(r==0){this.showDiv("NoGift");return}this.showDiv("Gift"),l("TradingComputer_gift_number").innerText=r.toString(),l("TradingComputer_gift_type").innerText=t.sells.id,l("TradingComputer_gift_take").onclick=()=>{e.playerShip.putCargo(t.sells,r),this.showDiv("Done")};return}if(e.playerShip.cargoTypes[t.buys.id]<1){this.showDiv("NothingToTradde");return}this.showDiv("Trade");let o=l("TradingComputer_give_slider");l("TradingComputer_give_type").innerText=t.buys.id,l("TradingComputer_get_type").innerText=t.sells.id,o.value=o.max=e.playerShip.cargoTypes[t.buys.id].toString(),o.style.display=e.playerShip.cargoTypes[t.buys.id]==1?"none":"",o.onchange=()=>{let r=parseInt(o.value),n=Math.round(r*t.ratio);l("TradingComputer_max_cargo_warning").style.display=n-r>e.playerShip.freeCargo?"":"none",n=Math.min(n,e.playerShip.freeCargo+r),l("TradingComputer_give_number").innerText=r.toString(),l("TradingComputer_get_number").innerText=n.toString()},o.onchange(),l("TradingComputer_deal").onclick=()=>{let r=parseInt(o.value),n=Math.round(r*t.ratio);n=Math.min(n,e.playerShip.freeCargo+r),e.playerShip.getCargo(t.buys,r),e.playerShip.putCargo(t.sells,n),this.showDiv("Done")}}};m(te,"TradingComputer");var he=class extends _{},oe=class extends he{missionBoxesToHere;deliveryMissionGivesBoxes;deliveryMissionGivesFreeCargoBay;divsShown=["",""];showDiv(e,t){this.divsShown[e]=t,l("currentComponentPage").innerHTML=this.divsShown.map((o,r)=>`#MissionComputer_${r}_${o}{display:block !important}`).join("")}fillRowSelectButtons(e,t){let o=P(s.playerShip.rows.length+1);o.unshift(-1),l(e).innerHTML=o.map(r=>`<button id="${e}_${r+1}">row ${String.fromCharCode(65+r)}</button>`).join(" "),o.forEach(r=>l(`${e}_${r+1}`).onclick=()=>{t(r,this)})}onEnter(e){let t=e.playerShip.onPlanet;if(!t)return;e.playerShip.countCargo();let o=e.playerShip.rows.flat().filter(B),r=[];for(let a of o)r=r.concat(a.cargo.filter(ae));let n=r.filter(a=>a.from===t.name);if(this.missionBoxesToHere=r.filter(a=>a.to===t.name),this.missionBoxesToHere.length){this.showDiv(0,"Complete");let a=Math.max(1,Math.floor(this.missionBoxesToHere.length/2));l("MissionComputer_Complete_resource").innerText=`${a} ${t.sells.id}`,l("MissionComputer_Complete_cargo").innerText=[t.deliveryMissionRockets?`${t.deliveryMissionRockets} Rockets`:"",t.deliveryMissionFuel?`${t.deliveryMissionFuel} Fuel`:""].filter(c=>!!c).join(" and "),l("MissionComputer_Complete_resource").onclick=()=>{e.playerShip.getMissionBox(t.name,this.missionBoxesToHere.length),e.playerShip.putCargo(t.sells,a),this.showDiv(0,"Completed")},l("MissionComputer_Complete_cargo").onclick=()=>{e.playerShip.getMissionBox(t.name,this.missionBoxesToHere.length),e.playerShip.putCargo(k,t.deliveryMissionRockets),e.playerShip.putCargo(D,t.deliveryMissionFuel),this.showDiv(0,"Completed")};let p=this.missionBoxesToHere.every(c=>c.total==this.missionBoxesToHere[0].total&&c.from==this.missionBoxesToHere[0].from)&&this.missionBoxesToHere[0].total==this.missionBoxesToHere.length;l("MissionComputer_Complete_component_wrap").style.display=p?"":"none",l("MissionComputer_Complete_component_name").innerText=t.deliveryMissionComponent.id,this.fillRowSelectButtons("MissionComputer_Complete_component_select",this.deliveryMissionCompleteSelect)}else if(n.length){this.showDiv(0,"InProgress");let a=n.map(c=>c.to),p=[...new Set(a)];l("MissionComputer_InProgress_to").innerText=p.join(", ")}else e.playerShip.freeCargo<4&&e.playerShip.componentTypes[O.id]>=4?this.showDiv(0,"NoSpace"):(this.showDiv(0,"Offer"),this.deliveryMissionGivesFreeCargoBay=e.playerShip.freeCargo<4,this.deliveryMissionGivesFreeCargoBay?this.deliveryMissionGivesBoxes=4:this.deliveryMissionGivesBoxes=Math.max(1,Math.floor(e.playerShip.freeCargo/5))*4,l("MissionComputer_Offer_n").innerText=this.deliveryMissionGivesBoxes.toString(),l("MissionComputer_Offer_to").innerText=t.deliveryMissionDest,l("MissionComputer_Offer_CargoBay").style.display=this.deliveryMissionGivesFreeCargoBay?"":"none",l("MissionComputer_Offer_NoCargoBay").style.display=this.deliveryMissionGivesFreeCargoBay?"none":"",l("MissionComputer_Offer_accept").onclick=()=>{e.playerShip.putMissionBox(t.name,t.deliveryMissionDest,this.deliveryMissionGivesBoxes),this.showDiv(0,"Started")},this.fillRowSelectButtons("MissionComputer_Offer_CargoBay_select",this.deliveryMissionFreeCargoBaySelect));t.buys?(this.showDiv(1,"Cargo"),l("MissionComputer_Cargo_n").innerText=20 .toString(),l("MissionComputer_Cargo_name").innerText=t.buys.id,l("MissionComputer_Cargo_deliver").style.display=e.playerShip.cargoTypes[t.buys.id]>=20?"":"none",l("MissionComputer_Cargo_component_name").innerText=t.cargoMissionComponent.id,this.fillRowSelectButtons("MissionComputer_Cargo_component_select",this.cargoMissionSelect)):this.showDiv(1,"None")}deliveryMissionFreeCargoBaySelect(e,t){let o=s.playerShip.onPlanet;o&&(s.playerShip.deBallastTail(),s.playerShip.addComponent(new O,e),s.playerShip.balanceBallast(),s.playerShip.countComponents(),s.playerShip.countCargo(),s.playerShip.putMissionBox(o.name,o.deliveryMissionDest,t.deliveryMissionGivesBoxes),s.walker.reattach(),t.showDiv(0,"Started"))}deliveryMissionCompleteSelect(e,t){let o=s.playerShip.onPlanet;if(!o)return;s.playerShip.deBallastTail(),s.playerShip.addComponent(new o.deliveryMissionComponent,e),s.playerShip.balanceBallast(),s.playerShip.countComponents(),s.playerShip.countCargo(),s.playerShip.getMissionBox(o.name,t.missionBoxesToHere.length),s.walker.reattach(),t.showDiv(0,"Completed");let r=Object.values(f).filter($);o.cargoMissionComponent=g(r)}cargoMissionSelect(e,t){let o=s.playerShip.onPlanet;if(!o?.buys)return;s.playerShip.deBallastTail(),s.playerShip.addComponent(new o.cargoMissionComponent,e),s.playerShip.balanceBallast(),s.playerShip.countComponents(),s.playerShip.countCargo(),s.playerShip.getCargo(o.buys,20),s.walker.reattach(),t.showDiv(1,"Completed");let r=Object.values(f).filter($);o.cargoMissionComponent=g(r)}};m(oe,"MissionComputer");function ze(i,e,t,o,r){let n=r**2*i**2+r**2*e**2-(t*e-o*i)**2,a=(-i*t-e*o+Math.sqrt(n))/(t**2+o**2-r**2),p=(-i*t-e*o-Math.sqrt(n))/(t**2+o**2-r**2);return Math.min(a,p)>0?Math.min(a,p):Math.max(a,p)}function ke(i,e,t,o,r){return r+ze(e.x-i.x,e.y-i.y,t.x,t.y,o)}var w=class i{name;color;color2;isAlien=!1;rows=[];offsets=[];componentTypes;cargoTypes;freeCargo;i;isPlayerShip=!1;playerOnShip=!1;playerX;playerY;x;y;fromPoint;toPlanet;fromTime;toTime;isIntercepting=!1;isBeingIntercepted=!1;interceptingShip;interceptionX;interceptionY;interceptionTime;updateSpaceXY(e,t=!0){if(this.isIntercepting)if(W(!this.interceptingShip.isIntercepting),e>=this.interceptionTime)W(this.interceptingShip.toTime>e),this.interceptingShip.updateSpaceXY(this.interceptionTime),this.isIntercepting=!1,this.interceptingShip.isBeingIntercepted=!1,this.fromTime=e,this.fromPoint.x=this.x=this.interceptingShip.x,this.fromPoint.y=this.y=this.interceptingShip.y;else{let o=(e-this.fromTime)/(this.interceptionTime-this.fromTime);this.x=this.fromPoint.x+(this.interceptionX-this.fromPoint.x)*o,this.y=this.fromPoint.y+(this.interceptionY-this.fromPoint.y)*o}else{for(;e>=this.toTime&&t;)W(!this.isIntercepting),W(!this.isBeingIntercepted),this.toPlanet.dispatch(this,this.toTime);let o=(e-this.fromTime)/(this.toTime-this.fromTime);this.x=this.fromPoint.x+(this.toPlanet.x-this.fromPoint.x)*o,this.y=this.fromPoint.y+(this.toPlanet.y-this.fromPoint.y)*o}}considerIntercept(e,t){if(this.isIntercepting||this.isBeingIntercepted)return;let o=M(e.filter(r=>r!=this&&!r.isIntercepting&&!r.isBeingIntercepted&&Math.hypot(this.x-r.x,this.y-r.y)>1&&r.seenBy({x:this.x,y:this.y},this.componentTypes[E.id])));for(let r of o){let n=(r.toPlanet.x-r.fromPoint.x)/(r.toTime-r.fromTime),a=(r.toPlanet.y-r.fromPoint.y)/(r.toTime-r.fromTime),p=ke(this,r,{x:n,y:a},2*.1,t);if(!(p>r.toTime-1)){this.isIntercepting=!0,this.interceptingShip=r,this.toPlanet=r.toPlanet,this.toTime=r.toTime,this.fromTime=t,this.fromPoint={x:this.x,y:this.y},this.interceptionX=r.x+n*(p-t),this.interceptionY=r.y+a*(p-t),this.interceptionTime=p,r.isBeingIntercepted=!0;break}}}planTrip(e,t,o){this.fromPoint=e,this.toPlanet=t,this.fromTime=o;let n=t.distanceTo(e)/.1;this.toTime=o+n,this.updateSpaceXY(this.fromTime)}countComponents(){this.componentTypes={};let e=Object.values(f).filter(_e).forEach(o=>this.componentTypes[o.id]=0),t=this.rows.flat();for(let o of t)this.componentTypes[o.typename]++}countCargo(){let e=this.rows.flat().filter(B);this.freeCargo=0,this.cargoTypes={},Object.values(f).filter(Z).forEach(t=>this.cargoTypes[t.id]=0);for(let t of e){this.freeCargo+=5-t.cargo.length;for(let o of t.cargo)this.cargoTypes[o.typename]++}}addComponent(e,t){e.ship=this,t<0&&(this.rows.unshift([]),this.rows.push([]),this.offsets.unshift(0),this.offsets.push(0),t=0),t>=this.rows.length&&(this.rows.unshift([]),this.rows.push([]),this.offsets.unshift(0),this.offsets.push(0),t=this.rows.length-1),this.rows[t].push(e)}getCargo(e,t){if(t>this.cargoTypes[e.id])return!1;this.cargoTypes[e.id]-=t,this.freeCargo+=t;let o=this.rows.flat().filter(B).filter(r=>r.cargo.length);for(let r of o)if(r.cargo=r.cargo.filter(n=>!(n instanceof e&&t-- >0)),t<=0)return!0}getMissionBox(e,t){if(t>this.cargoTypes[T.id])return!1;this.cargoTypes[T.id]-=t,this.freeCargo+=t;let o=this.rows.flat().filter(B).filter(r=>r.cargo.length);for(let r of o)if(r.cargo=r.cargo.filter(n=>!(n instanceof T&&n.to==e&&t-- >0)),t<=0)return!0}putCargo(e,t){if(t>this.freeCargo)return!1;this.cargoTypes[e.id]+=t,this.freeCargo-=t;let o=this.rows.flat().filter(B).filter(r=>r.cargo.length<5);for(let r of o){for(;t>0&&r.cargo.length<5;)r.cargo.push(new e),t--;if(t<=0)return!0}}putMissionBox(e,t,o){if(o>this.freeCargo)return!1;this.cargoTypes[T.id]+=o,this.freeCargo-=o;let r=this.rows.flat().filter(B).filter(a=>a.cargo.length<5),n=o;for(let a of r){for(;n>0&&a.cargo.length<5;){let p=new T;p.from=e,p.to=t,p.total=o,a.cargo.push(p),n--}if(n<=0)return!0}}seenBy(e,t){let o=Math.hypot(e.x-this.x,e.y-this.y);return!0}toJSON(){return{a:this.isAlien,n:this.name,c:this.color,o:this.offsets,r:this.rows.map(e=>e.map(t=>t.toJSON())),frX:this.fromPoint?.x,frY:this.fromPoint?.y,frT:this.fromTime,toP:this.toPlanet?.i,toT:this.toTime,ii:this.isIntercepting,ibi:this.isBeingIntercepted,is:this.interceptingShip?.i,iX:this.interceptionX,iY:this.interceptionY,iT:this.interceptionTime}}static fromJSON(e,t,o){o||(o=new i),o.isAlien=e.a,o.name=e.n,o.color=e.c,o.color2="#"+re(e.c.substr(1)),o.offsets=e.o,o.rows=[];for(let r=0;r<e.r.length;r++){o.rows[r]=[];for(let n=0;n<e.r[r].length;n++)o.addComponent(ne(e.r[r][n]),r)}return o.fromPoint={x:e.frX,y:e.frY},o.fromTime=e.frT,o.toTime=e.toT,t&&(o.toPlanet=t.planets[e.toP]),e.ii&&(o.isIntercepting=e.ii,o.interceptionX=e.iX,o.interceptionY=e.iY,o.interceptionTime=e.iT),o.isBeingIntercepted=e.ibi,o.fillBallastOpposite(),o.countComponents(),o}get gridSize(){if(this.isAlien)return{x0:0,x1:0,y0:0,y1:0,w:0,h:0};{let e=0,t=0;for(let o=0;o<this.rows.length;o++)e=Math.max(e,this.rows[o].length-this.offsets[o]),t=Math.max(t,this.offsets[o]);return{x0:0,x1:this.rows.length-1,y0:e,y1:t,w:this.rows.length,h:e+t+1}}}rowToXY(e,t){return this.isAlien?{x:0,y:0}:t>=this.offsets[e]?{x:e,y:1+(t-this.offsets[e])}:{x:e,y:t-this.offsets[e]}}get passage(){return this.isAlien?{x:0,y:0,w:0,h:0}:{x:0,y:0,w:this.rows.length,h:1}}oppositeComponent(e){for(let t=0;t<=this.rows.length;t++){let o=this.rows[t].indexOf(e);if(o>=0)return this.rows[this.rows.length-1-t][o]}}static randomShip(e,t){let r=Object.values(f).filter($),n=Object.values(f).filter(Pe),a=r.concat(n),p=Object.values(f).filter(Z);t===void 0&&(t=new i);let c=g(de);t.color="#"+c,t.color2="#"+re(c),t.rows=[[],[],[],[]],t.offsets=[0,0,0,0];for(let x=0;x<e;x++){let d=g(a),v=new d;if(v instanceof O){let j=b(0,5);for(let Ce=0;Ce<j;Ce++){let He=g(p);v.cargo.push(new He)}}t.addComponent(v,b(0,3))}for(let x=0;x<t.rows.length;x++)t.offsets[x]=b(0,t.rows[x].length);return t.balanceBallast(),t.countComponents(),t}static newBase(){let e=new i,t=g(de);e.color="#"+t,e.color2="#"+re(t),e.rows=[[],[],[]];let o=M([new ee,new E,new te,new oe]);for(let r of o)e.addComponent(r,b(0,2));return e.offsets=[b(0,e.rows[0].length),b(0,e.rows[1].length),b(0,e.rows[2].length)],e.balanceBallast(),e.countComponents(),e}deBallastTail(){if(!this.isAlien){let t=this.rows.length-1;for(var e=0;e<=t;e++)for(;this.rows[e].at(-1)instanceof C;)this.rows[e].pop()}}balanceBallast(){if(!this.isAlien){let t=this.rows.length-1;for(var e=0;e<=t;e++)for(;this.offsets[e]<this.offsets[t-e];)this.rows[e].unshift(new C),this.offsets[e]++;for(var e=0;e<=t;e++)for(;this.rows[e].length<this.rows[t-e].length;)this.rows[e].push(new C);for(var e=0;e<=t;e++)for(;this.rows[e][0]instanceof C&&this.rows[t-e][0]instanceof C;)this.rows[e].shift(),this.rows[t-e].shift(),this.offsets[e]--,this.offsets[t-e]++;for(var e=0;e<=t;e++)for(;this.rows[e].at(-1)instanceof C&&this.rows[t-e].at(-1)instanceof C;)this.rows[e].pop(),this.rows[t-e].pop()}this.fillBallastOpposite()}fillBallastOpposite(){if(!this.isAlien){let o=this.rows.length-1;for(var e=0;e<=o;e++)for(var t=0;t<=this.rows[e].length;t++)this.rows[e][t]instanceof C&&(this.rows[e][t].opposite=this.rows[o-e][t].typename)}}get topAirlock(){if(this.isAlien)return 0;{let e=0;for(let t=0;t<this.rows.length;t++)e=Math.max(e,this.rows[t].length-this.offsets[t]);for(let t=0;t<this.rows.length;t++)if(this.rows[t].length-this.offsets[t]==e)return t;return 0}}get bottomAirlock(){if(this.isAlien)return 0;{let e=Math.max(...this.offsets);return this.offsets.lastIndexOf(e)}}};var De=function(){let i=[N,F,z,q];for(var e=[[null,"water-mining","farming","burning"],["ice",null,"hunting","fire"],["fishy","bio-mining",null,"nuclear"],["frozen","hot mining","ice-farming",null]],t=[["ocean",null,N,"navy","blue"],["desert",N,D,"blue","purple"],["factory",F,k,"yellow","orange"],["war",k,D,"orange","purple"]],o=0;o<4;o++)for(var r=0;r<4;r++)o!=r&&t.push([e[o][r],i[o],i[r],i[o].color,i[r].color]);return t}(),ce=class i{x;y;i;type;name;buys;sells;ratio;color_in;color_out;neighbours;base;deliveryMissionDest;deliveryMissionComponent;deliveryMissionRockets;deliveryMissionFuel;cargoMissionComponent;constructor(e){var t=De[e];this.type=e,this.name=t[0],this.buys=t[1],this.sells=t[2],this.color_in=t[3],this.color_out=t[4]}distanceTo(e){return Math.hypot(this.x-e.x,this.y-e.y)}toJSON(){return{x:this.x,y:this.y,tp:this.type,b:this.base.toJSON(),dd:this.deliveryMissionDest,dc:this.deliveryMissionComponent?.id,dr:this.deliveryMissionRockets,df:this.deliveryMissionFuel,cc:this.cargoMissionComponent?.id}}static fromJSON(e){let t=new i(e.tp);return t.x=e.x,t.y=e.y,e.b?t.base=w.fromJSON(e.b):t.base=w.newBase(),e.dd&&(t.deliveryMissionDest=e.dd),e.dc&&(t.deliveryMissionComponent=f[e.dc]),e.dr&&(t.deliveryMissionRockets=e.dr),e.df&&(t.deliveryMissionFuel=e.df),e.cc&&(t.cargoMissionComponent=f[e.cc]),t}dispatch(e,t){let o=this.neighbours.shift();this.neighbours.push(o),e.planTrip(this,o,t)}onEnter(){this.deliveryMissionDest=g(this.neighbours).name;let e=Object.values(f).filter($);this.cargoMissionComponent=g(e),this.deliveryMissionComponent=g(e);let t=s.playerShip.rows.flat().filter(B),o=[];for(let n of t)o=o.concat(n.cargo.filter(ae));let r=o.filter(n=>n.to===this.name);if(r.length){let n=Math.max(1,Math.floor(r.length/2));this.deliveryMissionRockets=b(0,n),this.deliveryMissionFuel=n-this.deliveryMissionRockets}}};function qe(i,e,t){var o=t/2;return i<o+.6&&i>o-.6&&e<o+.6&&e>o-.6}function Oe(i){for(var e=M(P(De.length)),t=0;t<100;t++){for(var o=!1,r=[],n=M(P(i)),a=M(P(i)),p=i/2,c=0;c<i;c++)qe(n[c]+.5,a[c]+.5,i)&&(o=!0),r.push({x:n[c]+.5,y:a[c]+.5,tp:e[c]});if(!o)return r}return console.error("should not be here"),[]}var Ze=["AliceBlue","AntiqueWhite","Aqua","Aquamarine","Azure","Beige","Bisque","BlanchedAlmond","Blue","BlueViolet","Brown","BurlyWood","CadetBlue","Chartreuse","Chocolate","Coral","CornflowerBlue","Cornsilk","Crimson","Cyan","DarkGray","DarkGrey","DarkKhaki","DarkOrange","DarkOrchid","DarkSalmon","DarkSeaGreen","DarkTurquoise","DarkViolet","DeepPink","DeepSkyBlue","DimGray","DodgerBlue","FireBrick","FloralWhite","Fuchsia","Gainsboro","GhostWhite","Gold","Goldenrod","Gray","GreenYellow","Grey","Honeydew","HotPink","IndianRed","Ivory","Khaki","Lavender","LavenderBlush","LawnGreen","LemonChiffon","LightBlue","LightCoral","LightCyan","LightGoldenrodYellow","LightGray","LightGreen","LightGrey","LightPink","LightSalmon","LightSeaGreen","LightSkyBlue","LightSlateGray","LightSlateGrey","LightSteelBlue","LightYellow","Lime","LimeGreen","Linen","Magenta","MediumAquamarine","MediumBlue","MediumOrchid","MediumPurple","MediumSeaGreen","MediumSlateBlue","MediumSpringGreen","MediumTurquoise","MediumVioletRed","MintCream","MistyRose","Moccasin","NavajoWhite","OldLace","Orange","OrangeRed","Orchid","PaleGoldenrod","PaleGreen","PaleTurquoise","PaleVioletRed","PapayaWhip","PeachPuff","Peru","Pink","Plum","PowderBlue","Red","RosyBrown","RoyalBlue","Salmon","SandyBrown","Seashell","Sienna","Silver","SkyBlue","SlateBlue","SlateGray","SlateGrey","Snow","SpringGreen","SteelBlue","Tan","Thistle","Tomato","Turquoise","Violet","Wheat","White","WhiteSmoke","Yellow","YellowGreen"];function Ve(i,e){for(var t=P(e).map(a=>[]),o=(e-1)/2,r=Math.floor(o);r<=Math.ceil(o);r++)for(var n=Math.floor(o);n<=Math.ceil(o);n++)t[r+1][n+1]=i;return t}var X=class{color;size;bright;name;grid;planets;ships;constructor(e){e||(e={c:g(Ze),sz:b(5,9),p:!1,sh:!1}),this.color=e.c,this.size=e.sz,this.bright=!1,this.name=this.color,this.size%2==0&&(this.bright=!0,this.name="bright "+this.name),this.grid=Ve(this,this.size),e.p||(e.p=Oe(this.size)),this.planets=e.p.map(t=>ce.fromJSON(t));for(let t=0;t<this.planets.length;t++){let o=this.planets[t];o.i=t,o.neighbours=M(this.planets.filter(r=>r!=o&&!this.pathCollides(r,o))),this.grid[Math.floor(o.x)][Math.floor(o.y)]=o}if(e.sh){this.ships=e.sh.map(t=>t.p?S.fromJSON(t,this):w.fromJSON(t,this));for(let t=0;t<this.ships.length;t++)this.ships[t].i=t,this.ships[t].isIntercepting&&(this.ships[t].interceptingShip=this.ships[e.sh[t].is])}this.setRatios()}pathCollides(e,t){if(ge(e,t,{x:this.size/2,y:this.size/2},.5))return!0;for(var o of this.planets)if(o!=e&&o!=t&&ge(e,t,o,.2))return!0;return!1}computeRareResources(e){e===void 0&&(e=this.planets);let t=e.map(n=>n.sells),o=Object.values(f).filter(Z).filter(n=>!t.includes(n)),r=e.filter(n=>n.buys===null).map(n=>n.sells);return{exotic:o,abundant:r}}setRatios(){let e=this.computeRareResources();for(let t of this.planets)t.buys===null?t.ratio=2:e.abundant.includes(t.buys)?t.ratio=1:e.exotic.includes(t.buys)?t.ratio=2:t.ratio=1.4}addRandomShips(e){this.ships=[];for(let t=0;t<this.planets.length;t++)for(let o=0;o<t;o++){if(this.planets[t].neighbours.indexOf(this.planets[o])<0)continue;let r=w.randomShip(15),a=Math.hypot(this.planets[t].x-this.planets[o].x,this.planets[t].y-this.planets[o].y)/.1;this.planets[t].dispatch(r,e-a),this.ships.push(r),this.ships.at(-1).i=this.ships.length-1}}toJSON(){return{c:this.color,sz:this.size,p:this.planets.map(e=>e.toJSON()),sh:this.ships.map(e=>e.toJSON())}}};var me=class i{star;playerShip;walker;now=0;lastTickTimestamp;lastDate;_timeFlies=!1;tickInterval=0;get timeFlies(){return this._timeFlies}set timeFlies(e){if(this._timeFlies!=e)if(this._timeFlies=e,e){let t=this;this.lastTickTimestamp=performance.now(),this.tickInterval=setInterval(function(){t.tick()},1e3)}else clearInterval(this.tickInterval)}tick(e){if(!this._timeFlies)return!1;if(e||(e=performance.now()),e<=this.lastTickTimestamp)return!0;this.now+=Math.max(0,Math.min(e-this.lastTickTimestamp,1e3))/1e3,this.lastTickTimestamp=e;let t=Math.floor(this.now);for(let o of this.star.ships)o.updateSpaceXY(this.now);if(this.lastDate!=t){if(ie(t),this.lastDate=t,this._timeFlies){let o=Math.ceil(this.playerShip.toTime-this.now);ye(`Approaching ${this.playerShip.toPlanet.name} planet in ${o} days`)}for(let o of this.star.ships)o.considerIntercept(this.star.ships,this.now)}return!0}depart(){this.timeFlies=!0,this.playerShip.onPlanet=null,this.walker.detach(),this.lastDate=-1,this.tick()}arrive(e,t){this.playerShip.onPlanet=this.playerShip.toPlanet,this.playerShip.x=this.playerShip.onPlanet.x,this.playerShip.y=this.playerShip.onPlanet.y,this.timeFlies=!1,e||this.playerShip.onPlanet.onEnter(),this.walker.attach(this.playerShip.onPlanet.base),ye(`Docked to base at ${this.playerShip.onPlanet.name} planet`),t||(localStorage.space2d3_2=JSON.stringify(this.toJSON()))}toJSON(){return{v:2,s:this.star.toJSON(),n:this.now}}static fromJSON(e){if(e?.v!=2)return!1;let t=new i;t.star=new X(e.s);let o=t.star.ships.filter(Ne);return o.length!=1?!1:(t.playerShip=o[0],t.now=e.n,t)}};function Ge(i){let e=me.fromJSON(i);return e?(s=e,!0):!1}function Re(){s&&(s._timeFlies=!1),s=new me}var s;var S=class i extends w{onPlanet;updateSpaceXY(e,t=!0){super.updateSpaceXY(e,!1),e>=this.toTime&&t&&s.arrive()}considerIntercept(){}static randomShip(e){let t=new i;return w.randomShip(e,t),t}toJSON(){let e=super.toJSON();return e.p=!0,this.onPlanet!=null&&(e.on=this.onPlanet.i),e}static fromJSON(e,t){let o=new i;return w.fromJSON(e,t,o),o}};function Ne(i){return i instanceof S}var fe=class{x;y;map;box;human;canvas;ctx;onEnter;oneShipData;twoShipsData;hasSecondShip=!1;myShip;secondShip;newMap(e,t){this.map=[];for(let o=0;o<=e;o++){this.map[o]=[];for(let r=0;r<=t;r++)this.map[o][r]={}}}goX(e){return!this.map[this.x][this.y].canGoX||!this.map[this.x+e][this.y].canBeHere?!1:(this.x+=e,this.reposition(),this.onEnter(this.map[this.x][this.y].component),!0)}goY(e,t){return!t&&!this.map[this.x][this.y].canGoY||!this.map[this.x][this.y+e].canBeHere?!1:(this.y+=e,this.reposition(),this.onEnter(this.map[this.x][this.y].component),!0)}goUp(){this.goY(-1),this.human.style.transform="rotate(0deg)"}goDn(e){this.goY(1,e),this.human.style.transform="rotate(180deg)"}goLt(){this.goX(-1),this.human.style.transform="rotate(-90deg)"}goRt(){this.goX(1),this.human.style.transform="rotate(90deg)"}jumpTo(e,t,o=!0){this.x=e,this.y=t,this.reposition(!0),o&&this.onEnter(this.map[e][t].component)}reposition(e){e&&this.canvas.classList.add("notransition");let t=(this.x+.5)*h,r=this.box.offsetWidth/2-t;this.canvas.style.left=r+"px";let n=(this.y+.5)*h,p=this.box.offsetHeight/2-n;this.canvas.style.top=p+"px",e&&(this.canvas.offsetHeight,this.canvas.classList.remove("notransition"))}putTwoShips(e,t){let o=e.gridSize,r=t.gridSize,n=e.bottomAirlock,a=t.topAirlock,p=Math.max(n,a)+1,c=o.h+1,x=p+Math.max(o.w-n,r.w-a),d=c+r.h+1;this.myShip=t,this.secondShip=e,this.hasSecondShip=!0,this.twoShipsData={ax0:p-n+o.x0,ay0:o.y0+1,airlock_x:p,airlock_y:c,bx0:p-a+r.x0,by0:c+r.y0+1,max_x:x,max_y:d}}drawTwoShips(e,t){this.putTwoShips(e,t);let o=this.twoShipsData;this.newMap(o.max_x,o.max_y),this.ctx.canvas.width=h*(o.max_x+1),this.ctx.canvas.height=h*(o.max_y+1),le(this.ctx,o.ax0,o.ay0,e,this.map),le(this.ctx,o.bx0,o.by0,t,this.map),ve(this.ctx,o.airlock_x,o.airlock_y,e,t,this.map)}drawMyShip(){this.hasSecondShip=!1;let e=this.oneShipData=this.myShip.gridSize;this.newMap(e.w+1,e.h+1),this.ctx.canvas.width=h*(e.w+2),this.ctx.canvas.height=h*(e.h+2),le(this.ctx,e.x0+1,e.y0+1,this.myShip,this.map)}detach(){if(!this.hasSecondShip)return!1;let e=!1;if(this.y==this.twoShipsData.airlock_y&&(this.y++,e=!0),this.secondShip.playerOnShip=this.y<this.twoShipsData.airlock_y,this.myShip.playerOnShip=this.y>this.twoShipsData.airlock_y,!(this.y<this.twoShipsData.airlock_y)){let t=this.myShip.playerX=this.x-this.twoShipsData.bx0,o=this.myShip.playerY=this.y-this.twoShipsData.by0;this.drawMyShip(),e?(this.jumpTo(this.oneShipData.x0+1+t,this.oneShipData.y0+o,!1),this.goDn(!0)):this.jumpTo(this.oneShipData.x0+1+t,this.oneShipData.y0+1+o,!1)}}attach(e){if(this.hasSecondShip)return!1;let t=this.x-1-this.oneShipData.x0,o=this.y-1-this.oneShipData.y0;this.drawTwoShips(e,this.myShip),this.jumpTo(this.twoShipsData.bx0+t,this.twoShipsData.by0+o)}reattach(){if(!this.hasSecondShip)return!1;if(this.y>=this.twoShipsData.airlock_y)return;let e=this.secondShip.playerX=this.x-this.twoShipsData.ax0,t=this.secondShip.playerY=this.y-this.twoShipsData.ay0;this.drawTwoShips(this.secondShip,this.myShip),this.jumpTo(this.twoShipsData.ax0+e,this.twoShipsData.ay0+t)}};(location.hostname=="localhost"||location.hostname=="127.0.0.1")&&new EventSource("/esbuild").addEventListener("change",()=>location.reload());var Le={a:!1,n:"Your Ship",c:"#5E5E5E",o:[0,0],r:[[{t:"CargoBay",c:[{t:"Water"},{t:"Food"},{t:"Iron"},{t:"Radioactives"}]}],[{t:"Ballast"}]],frX:0,frY:0,frT:-1,toP:0,toT:0,p:!0};window.matchMedia("(prefers-color-scheme: dark)").matches&&(Le.c="#919191");var y=new fe,Ee=l("myCanvas"),Ke=Ee.getContext("2d");y.box=l("canvasBox");y.human=l("human");y.canvas=Ee;y.ctx=Ke;y.onEnter=Qe;window.onresize=()=>{s.walker.reposition(!0)};function Ie(i){Re(),s.star=new X,s.star.addRandomShips(0),i?s.playerShip=S.fromJSON(i,s.star):s.playerShip=S.randomShip(15),s.star.ships.push(s.playerShip),s.playerShip.planTrip({x:s.star.planets[0].x-.1,y:s.star.planets[0].y},s.star.planets[0],-1),s.now=0,Ae(!0)}function Ue(){return Ge(JSON.parse(localStorage.space2d3_2))?(Ae(),!0):!1}function Ae(i=!1){y.myShip=s.playerShip,y.drawMyShip(),y.jumpTo(y.oneShipData.x0+1,y.oneShipData.y0+1),s.walker=y,l("main").style.display="flex",s.arrive(!i,i),ie(Math.floor(s.now));let t=l("systemCanvas").getContext("2d");Te(t,s.star);for(let o of s.star.ships)o.updateSpaceXY(s.now,!1);window.gs=s}l("newGameEasy").onclick=()=>{Ie(Le)};l("newGameHard").onclick=()=>{Ie()};localStorage.space2d3_2?Ue()||(localStorage.space2d3_2=prompt("Error loading game. Fix savegame data below or press Cancel to delete savegame and start anew",localStorage.space2d3_2)||"",location.reload()):l("newGameDialog").showModal();l("newGameButton").onclick=()=>{l("newGameCancelBox").style.display="",l("newGameDialog").showModal()};window.onkeypress=i=>{switch(i.key){case"w":y.goUp();break;case"a":y.goLt();break;case"s":y.goDn();break;case"d":y.goRt();break}};function Qe(i){i&&(l("currentComponent").innerHTML=`#${i.typename} {display:block}`,i.cellName?l("componentLegend").innerText=`${i.cellName}: ${i.typename}`:l("componentLegend").innerText=`${i.typename}`,i.onEnter(s))}})();
//# sourceMappingURL=script.js.map
