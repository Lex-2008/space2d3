(()=>{var g=class{static id;get mytype(){return this.constructor}get typename(){return this.mytype.id}toJSON(){return{type:this.typename}}static fromJSON(e,t){return new e}};function H(r){let e=L[r.type];return e.fromJSON(e,r)}var L={};function m(r,e){L[e]=r,r.id=e}var w=class extends g{},N=class extends w{},X=class extends N{};m(X,"Rocket");var F=class extends N{};m(F,"Fuel");var b=class extends w{},S=class extends b{static color="blue"};m(S,"Water");var x=class extends b{static color="yellow"};m(x,"Iron");var _=class extends b{static color="green"};m(_,"Food");var O=class extends b{static color="red"};m(O,"Radioactives");var i=50,p=5;function me(r,e,t,o,n,a){o.isAlien?r.rect(e*i,t*i+p,i,i-2*p):r.rect(e*i+p,t*i,i-2*p,i),r.strokeStyle="white",r.fillStyle="white",r.stroke(),r.textBaseline="top",r.fillText(n.cellName||"",e*i+p,t*i),r.fillText(n.typename[0],e*i+p,t*i+16),a&&(a.map[e][t].canBeHere=!0,a.map[e][t].canGoX=o.isAlien,a.map[e][t].canGoY=!o.isAlien,a.map[e][t].ship=o,a.map[e][t].component=n)}function pe(r,e,t,o,n){let a=o.passage;if(r.rect((e+a.x)*i,(t+a.y)*i,a.w*i,a.h*i),r.strokeStyle="white",r.fillStyle="white",r.stroke(),r.textBaseline="top",n){let s=new R;for(let l=0;l<a.w;l++)for(let h=0;h<a.h;h++)n.map[l+e][h+t].canBeHere=!0,n.map[l+e][h+t].canGoX=!0,n.map[l+e][h+t].canGoY=!0,n.map[l+e][h+t].ship=o,n.map[l+e][h+t].component=s}}function te(r,e,t,o){r.strokeStyle="white",r.strokeStyle="white",r.fillStyle="white",r.beginPath(),r.moveTo(e*i+p,t*i),r.lineTo(e*i+p*2,(t+.5)*i),r.lineTo(e*i+p,(t+1)*i),r.lineTo((e+1)*i-p,(t+1)*i),r.lineTo((e+1)*i-p*2,(t+.5)*i),r.lineTo((e+1)*i-p,t*i),r.closePath(),r.stroke(),o&&(o.map[e][t].canBeHere=!0,o.map[e][t].canGoY=!0,o.map[e][t].component=new A)}function Y(r,e,t,o,n){for(let a=0;a<o.rows.length;a++)for(let s=0;s<o.rows[a].length;s++){let l=o.rows[a][s],h=o.rowToXY(a,s);l.cellName=String.fromCharCode(65+a)+h.y,me(r,e+h.x,t-h.y,o,l,n)}pe(r,e,t,o,n)}function fe(r,e,t,o,n){e.updateSpaceXY(n);let a=e.spaceX*t,s=e.spaceY*t;r.fillStyle="#"+e.color,r.fillRect(a,s,2,2),r.beginPath(),r.arc(a,s,t,0,7),r.strokeStyle="red",r.stroke()}function ce(r,e,t,o){let n=e.x*t,a=e.y*t;var s=r.createRadialGradient(n-1,a-1,2,n,a,o);s.addColorStop(0,e.color_in),s.addColorStop(1,e.color_out),r.fillStyle=s,r.beginPath(),r.arc(n,a,o,0,6),r.fill()}function re(r,e,t){let o=r.canvas.width,n=o/e.size,a=n/5,s=o/2;if(r.clearRect(0,0,o,o),e.bright){let l=r.createRadialGradient(s,s,0,s,s,n/2);l.addColorStop(0,"white"),l.addColorStop(.5,e.color),l.addColorStop(1,"transparent"),r.fillStyle=l,r.fillRect(0,0,o,o)}else{let l=r.createRadialGradient(s,s,10,s,s,n/2);l.addColorStop(0,e.color),l.addColorStop(1,"transparent"),r.fillStyle=l,r.fillRect(0,0,o,o)}for(let l of e.planets)ce(r,l,n,a);if(t!==void 0)for(let l of e.ships)fe(r,l,n,0,t)}var W=class extends g{cellName="";onEnter(e){}},v=class extends W{},A=class extends v{};m(A,"Airlock");var R=class extends v{};m(R,"Passage");var f=class extends v{opposite="";onEnter(e){document.querySelector("#Ballast b").innerText=this.opposite||""}};m(f,"Ballast");var V=class r extends v{original="";toJSON(){return{type:this.typename,original:this.original}}static fromJSON(e,t){let o=new r;return o.original=t.original,o}};m(V,"Debris");var k=class extends W{},G=class r extends k{cargo=[];toJSON(){return{type:this.typename,cargo:this.cargo.map(e=>e.toJSON())}}static fromJSON(e,t){let o=new r;return o.cargo=t.cargo.map(n=>H(n)),o}onEnter(e){document.querySelector("#CargoBay ul").innerHTML=this.cargo.map(t=>`<li>${t.typename}</li>`).join(""),document.getElementById("CargoBay_Empty").style.display=this.cargo.length==0?"":"none",document.getElementById("CargoBay_NonEmpty").style.display=this.cargo.length==0?"none":""}};m(G,"CargoBay");var $=class extends k{onEnter(e){let o=document.querySelector("#Radar canvas").getContext("2d");e.realTimestamp=performance.now(),window.requestAnimationFrame(oe)}};m($,"Radar");function oe(r){let e=document.querySelector("#Radar canvas");if(e.offsetParent===null)return;let t=e.getContext("2d"),o=window.gs;o.now+=Math.max(0,Math.min(r-o.realTimestamp,1e3))/1e3,console.log(Math.round(o.now)),o.realTimestamp=r,re(t,o.star,o.now),window.requestAnimationFrame(oe)}var ne=["000000","2f4f4f","556b2f","8b4513","8b0000","808000","483d8b","5f9ea0","008000","3cb371","4682b4","d2691e","9acd32","cd5c5c","00008b","32cd32","daa520","8fbc8f","800080","b03060","ff0000","00ced1","ff8c00","ffd700","ffff00","0000cd","deb887","00ff00","00fa9a","8a2be2","dc143c","00bfff","adff2f","ff6347","da70d6","b0c4de","ff00ff","f0e68c","6495ed","dda0dd","ff1493","7b68ee","ffa07a","afeeee","98fb98","7fffd4","fafad2","ff69b4","ffb6c1","fff0f5"];function C(r,e){return r>e&&([r,e]=[e,r]),Math.floor(Math.random()*(e-r+1))+r}function T(r){return r[Math.floor(Math.random()*r.length)]}function D(r){return r.map(e=>({sort:Math.random(),value:e})).sort((e,t)=>e.sort-t.sort).map(e=>e.value)}function M(r){return[...Array(r).keys()]}var d=class r{color;isAlien=!1;rows=[];offsets=[];isPlayerShip=!1;playerOnShip=!1;playerX;playerY;spaceX;spaceY;fromPlanet;toPlanet;fromTime;toTime;updateSpaceXY(e){for(;e>=this.toTime;)this.toPlanet.dispatch(this,this.toTime);let t=(e-this.fromTime)/(this.toTime-this.fromTime);this.spaceX=this.fromPlanet.x+(this.toPlanet.x-this.fromPlanet.x)*t,this.spaceY=this.fromPlanet.y+(this.toPlanet.y-this.fromPlanet.y)*t}toJSON(){return{isAlien:this.isAlien,offsets:this.offsets,rows:this.rows.map(e=>e.map(t=>t.toJSON()))}}static fromJSON(e){let t=new r;return t.isAlien=e.isAlien,t.offsets=e.offsets,t.rows=e.rows.map(o=>o.map(n=>H(n))),t}get gridSize(){if(this.isAlien)return{x0:0,x1:0,y0:0,y1:0,w:0,h:0};{let e=0,t=0;for(let o=0;o<this.rows.length;o++)e=Math.max(e,this.rows[o].length-this.offsets[o]),t=Math.max(t,this.offsets[o]);return{x0:0,x1:this.rows.length-1,y0:e,y1:t,w:this.rows.length,h:e+t+1}}}rowToXY(e,t){return this.isAlien?{x:0,y:0}:t>=this.offsets[e]?{x:e,y:1+(t-this.offsets[e])}:{x:e,y:t-this.offsets[e]}}get passage(){return this.isAlien?{x:0,y:0,w:0,h:0}:{x:0,y:0,w:this.rows.length,h:1}}oppositeComponent(e){for(let t=0;t<=this.rows.length;t++){let o=this.rows[t].indexOf(e);if(o>=0)return this.rows[this.rows.length-1-t][o]}}static randomShip(e){let o=Object.values(L).filter(s=>s.prototype instanceof k),n=Object.values(L).filter(s=>s.prototype instanceof w),a=new r;a.color=T(ne),a.rows=[[],[],[],[]],a.offsets=[0,0,0,0];for(let s=0;s<e;s++){let l=C(0,3),h=T(o),P=new h;if(P instanceof G){let I=C(0,4);for(let ee=0;ee<I;ee++){let he=T(n);P.cargo.push(new he)}}a.rows[l].push(P)}for(let s=0;s<a.rows.length;s++)a.offsets[s]=C(0,a.rows[s].length);return a.balanceBallast(),a}balanceBallast(){if(!this.isAlien){let o=this.rows.length-1;for(var e=0;e<=o;e++)for(;this.offsets[e]<this.offsets[o-e];)this.rows[e].unshift(new f),this.offsets[e]++;for(var e=0;e<=o;e++)for(;this.rows[e].length<this.rows[o-e].length;)this.rows[e].push(new f);for(var e=0;e<=o;e++)for(;this.rows[e][0]instanceof f&&this.rows[o-e][0]instanceof f;)this.rows[e].shift(),this.rows[o-e].shift(),this.offsets[e]--,this.offsets[o-e]++;for(var e=0;e<=o;e++)for(;this.rows[e].at(-1)instanceof f&&this.rows[o-e].at(-1)instanceof f;)this.rows[e].pop(),this.rows[o-e].pop();for(var e=0;e<=o;e++)for(var t=0;t<=this.rows[e].length;t++)this.rows[e][t]instanceof f&&(this.rows[e][t].opposite=this.rows[o-e][t].typename)}}get topAirlock(){if(this.isAlien)return 0;{let e=0;for(let t=0;t<this.rows.length;t++)e=Math.max(e,this.rows[t].length-this.offsets[t]);for(let t=0;t<this.rows.length;t++)if(this.rows[t].length-this.offsets[t]==e)return t;return 0}}get bottomAirlock(){if(this.isAlien)return 0;{let e=Math.max(...this.offsets);return this.offsets.lastIndexOf(e)}}};var K=class{canBeHere=!1;canGoX=!1;canGoY=!1;ship;component},E=class{map=[];constructor(e,t){for(let o=0;o<=e;o++){this.map[o]=[];for(let n=0;n<=t;n++)this.map[o][n]=new K}}},q=class{x;y;map;box;human;canvas;onEnter;goX(e){return!this.map.map[this.x][this.y].canGoX||!this.map.map[this.x+e][this.y].canBeHere?!1:(this.x+=e,this.reposition(),this.onEnter(this.map.map[this.x][this.y].component),!0)}goY(e,t){return!t&&!this.map.map[this.x][this.y].canGoY||!this.map.map[this.x][this.y+e].canBeHere?!1:(this.y+=e,this.reposition(),this.onEnter(this.map.map[this.x][this.y].component),!0)}goUp(){this.goY(-1),this.human.style.transform="rotate(0deg)"}goDn(e){this.goY(1,e),this.human.style.transform="rotate(180deg)"}goLt(){this.goX(-1),this.human.style.transform="rotate(-90deg)"}goRt(){this.goX(1),this.human.style.transform="rotate(90deg)"}jumpTo(e,t,o,n){o!==void 0&&n!==void 0||(this.x=e,this.y=t,this.reposition(!0),this.onEnter(this.map.map[e][t].component))}reposition(e){e&&this.canvas.classList.add("notransition");let t=(this.x+.5)*i,n=this.box.offsetWidth/2-t;this.canvas.style.left=n+"px";let a=(this.y+.5)*i,l=this.box.offsetHeight/2-a;this.canvas.style.top=l+"px",e&&(this.canvas.offsetHeight,this.canvas.classList.remove("notransition"))}};var J=class{walker;oneShipData;twoShipsData;myShip;putTwoShips(e,t){let o=e.gridSize,n=t.gridSize,a=e.bottomAirlock,s=t.topAirlock,l=Math.max(a,s)+1,h=o.h+1,P=l+Math.max(o.w-a,n.w-s),I=h+n.h+1;this.twoShipsData={ax0:l-a+o.x0,ay0:o.y0+1,airlock_x:l,airlock_y:h,bx0:l-s+n.x0,by0:h+n.y0+1,max_x:P,max_y:I}}drawTwoShips(e,t,o){this.putTwoShips(t,o);let n=this.twoShipsData,a=new E(n.max_x,n.max_y);this.walker.map=a,e.canvas.width=i*(n.max_x+1),e.canvas.height=i*(n.max_y+1),Y(e,n.ax0,n.ay0,t,a),Y(e,n.bx0,n.by0,o,a),te(e,n.airlock_x,n.airlock_y,a)}drawMyShip(e){let t=this.oneShipData=this.myShip.gridSize,o=this.walker.map=new E(t.w+1,t.h+1);e.canvas.width=i*(t.w+2),e.canvas.height=i*(t.h+2),Y(e,t.x0+1,t.y0+1,this.myShip,o)}detach(e){let t=this.walker.x-this.twoShipsData.bx0,o=this.walker.y-this.twoShipsData.by0+1;this.drawMyShip(e),this.walker.jumpTo(this.oneShipData.x0+1+t,this.oneShipData.y0+o),this.walker.goDn(!0)}attach(e,t){let o=this.walker.x-1-this.oneShipData.x0,n=this.walker.y-1-this.oneShipData.y0;this.drawTwoShips(e,t,this.myShip),this.walker.jumpTo(this.twoShipsData.bx0+o,this.twoShipsData.by0+n)}};var ae=function(){let r=[S,x,_,O];for(var e=[[null,"water-mining","farming","burning"],["ice",null,"hunting","fire"],["fishy","bio-mining",null,"nuclear"],["frozen","hot mining","ice-farming",null]],t=[["ocean",null,S,"navy","blue"],["mining",null,x,"olive","yellow"]],o=0;o<4;o++)for(var n=0;n<4;n++)o!=n&&t.push([e[o][n],r[o],r[n],r[o].color,r[n].color]);return t}(),j=class{x;y;type;name;buys;sells;color_in;color_out;neighbours;constructor(e,t,o){var n=ae[o];this.x=e,this.y=t,this.type=o,this.name=n[0],this.buys=n[1],this.sells=n[2],this.color_in=n[3],this.color_out=n[4]}save(){return[this.x,this.y,this.type]}dispatch(e,t){let o=this.neighbours.shift();this.neighbours.push(o),e.fromPlanet=this,e.toPlanet=o,e.fromTime=t;let a=Math.hypot(this.x-o.x,this.y-o.y)/.1;e.toTime=t+a}};function ue(r,e,t){var o=t/2;return r<o+.6&&r>o-.6&&e<o+.6&&e>o-.6}function se(r){for(var e=D(M(ae.length)),t=0;t<100;t++){for(var o=!1,n=[],a=D(M(r)),s=D(M(r)),l=r/2,h=0;h<r;h++)ue(a[h]+.5,s[h]+.5,r)&&(o=!0),n.push([a[h]+.5,s[h]+.5,e[h]]);if(!o)return n}return console.error("should not be here"),[]}var de=["AliceBlue","AntiqueWhite","Aqua","Aquamarine","Azure","Beige","Bisque","BlanchedAlmond","Blue","BlueViolet","Brown","BurlyWood","CadetBlue","Chartreuse","Chocolate","Coral","CornflowerBlue","Cornsilk","Crimson","Cyan","DarkGray","DarkGrey","DarkKhaki","DarkOrange","DarkOrchid","DarkSalmon","DarkSeaGreen","DarkTurquoise","DarkViolet","DeepPink","DeepSkyBlue","DimGray","DodgerBlue","FireBrick","FloralWhite","Fuchsia","Gainsboro","GhostWhite","Gold","Goldenrod","Gray","GreenYellow","Grey","Honeydew","HotPink","IndianRed","Ivory","Khaki","Lavender","LavenderBlush","LawnGreen","LemonChiffon","LightBlue","LightCoral","LightCyan","LightGoldenrodYellow","LightGray","LightGreen","LightGrey","LightPink","LightSalmon","LightSeaGreen","LightSkyBlue","LightSlateGray","LightSlateGrey","LightSteelBlue","LightYellow","Lime","LimeGreen","Linen","Magenta","MediumAquamarine","MediumBlue","MediumOrchid","MediumPurple","MediumSeaGreen","MediumSlateBlue","MediumSpringGreen","MediumTurquoise","MediumVioletRed","MintCream","MistyRose","Moccasin","NavajoWhite","OldLace","Orange","OrangeRed","Orchid","PaleGoldenrod","PaleGreen","PaleTurquoise","PaleVioletRed","PapayaWhip","PeachPuff","Peru","Pink","Plum","PowderBlue","Red","RosyBrown","RoyalBlue","Salmon","SandyBrown","Seashell","Sienna","Silver","SkyBlue","SlateBlue","SlateGray","SlateGrey","Snow","SpringGreen","SteelBlue","Tan","Thistle","Tomato","Turquoise","Violet","Wheat","White","WhiteSmoke","Yellow","YellowGreen"];function ye(r,e){for(var t=M(e).map(s=>[]),o=(e-1)/2,n=Math.floor(o);n<=Math.ceil(o);n++)for(var a=Math.floor(o);a<=Math.ceil(o);a++)t[n+1][a+1]=r;return t}var z=class{color;size;visited;x;y;bright;name;grid;planets;ships;jobs;constructor(e){e||(e={c:T(de),s:C(5,9),p:!1,v:!1}),this.color=e.c,this.size=e.s,this.visited=e.v,this.x=this.y=this.size/2,this.bright=!1,this.name=this.color,this.size%2==0&&(this.bright=!0,this.name="bright "+this.name),this.grid=ye(this,this.size),e.p||(e.p=se(this.size)),this.planets=e.p.map(o=>new j(...o));for(var t of this.planets)t.neighbours=D(this.planets.filter(o=>o!=t)),this.grid[Math.floor(t.x)][Math.floor(t.y)]=t}addRandomShips(e){this.ships=[];for(let t=0;t<this.planets.length;t++)for(let o=0;o<t;o++){let n=d.randomShip(15),s=Math.hypot(this.planets[t].x-this.planets[o].x,this.planets[t].y-this.planets[o].y)/.1;this.planets[t].dispatch(n,e-s),this.ships.push(n)}}save(){return{c:this.color,s:this.size,p:this.planets.map(e=>e.save()),v:this.visited}}};function u(r){let e=document.getElementById(r);if(!e)throw ReferenceError(`element ${r} not found`);return e}function it(r){let e=u(r);if(!(e instanceof HTMLInputElement))throw ReferenceError(`element ${r} is not input`);return e}(location.hostname=="localhost"||location.hostname=="127.0.0.1")&&new EventSource("/esbuild").addEventListener("change",()=>location.reload());var ge=d.randomShip(15),lt=d.randomShip(35),Z={star:new z,now:0};window.gs=Z;Z.star.addRandomShips(0);var c=new q,y=new J;y.walker=c;var ie=u("myCanvas"),Q=ie.getContext("2d");c.box=u("canvasBox");c.human=u("human");c.canvas=ie;c.onEnter=be;function we(){y.myShip=ge,y.drawMyShip(Q),c.jumpTo(y.oneShipData.x0+1,y.oneShipData.y0+1),le()}function le(){y.attach(Q,d.randomShip(25)),B("Docked to another ship")}we();window.onkeypress=r=>{switch(r.key){case"w":c.goUp();break;case"a":c.goLt();break;case"s":c.goDn();break;case"d":c.goRt();break}};function be(r){r&&(u("currentComponent").innerHTML=`#${r.typename} {display:block}`,r.cellName?u("componentLegend").innerText=`${r.cellName}: ${r.typename}`:u("componentLegend").innerText=`${r.typename}`,r.onEnter(Z))}function B(r){u("status").innerText=r}u("Airlock_Detach").onclick=()=>{y.detach(Q),B("Docking to next ship in 5..."),setTimeout(()=>B("Docking to next ship in 4..."),1e3),setTimeout(()=>B("Docking to next ship in 3..."),2e3),setTimeout(()=>B("Docking to next ship in 2..."),3e3),setTimeout(()=>B("Docking to next ship in 1..."),4e3),setTimeout(()=>le(),5e3)};})();
//# sourceMappingURL=script.js.map
