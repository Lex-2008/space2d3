(()=>{function we(r){let e=parseInt(r,16),t=e>>16&255,o=e>>8&255,i=e&255,n=t/255,l=o/255,p=i/255;n>.04045?n=Math.pow((n+.055)/1.055,2.4):n=n/12.92,l>.04045?l=Math.pow((l+.055)/1.055,2.4):l=l/12.92,p>.04045?p=Math.pow((p+.055)/1.055,2.4):p=p/12.92,n=n*100,l=l*100,p=p*100;let d=(n*.2126+l*.7152+p*.0722)/100;return d>.008856?d=Math.pow(d,1/3):d=7.787*d+16/116,116*d-16}function ye(r){let e=(r+16)/116,t=e,o=e,i=95.047,n=100,l=108.883,[p,c,C]=[t,e,o].map(W=>Math.pow(W,3)>.008856?Math.pow(W,3):(W-16/116)/7.787);p*=i,c*=n,C*=l,t=p/100,e=c/100,o=C/100;let d=t*3.2406+e*-1.5372+o*-.4986,v=d>.0031308?1.055*Math.pow(d,1/2.4)-.055:12.92*d;return v=Math.round(v*255),(1<<24|v<<16|v<<8|v).toString(16).slice(1)}function b(r,e){return r>e&&([r,e]=[e,r]),Math.floor(Math.random()*(e-r+1))+r}function g(r){return r[Math.floor(Math.random()*r.length)]}function B(r){return r.map(e=>({sort:Math.random(),value:e})).sort((e,t)=>e.sort-t.sort).map(e=>e.value)}function k(r){return[...Array(r).keys()]}function a(r){let e=document.getElementById(r);if(!e)throw ReferenceError(`element ${r} not found`);return e}function re(r){a("status").innerText=r}function ie(r){a("now-day").innerText=(r+1).toString();let e=Math.floor(r/300)+3e3,t=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov"][Math.floor(r%300/30)],o=Math.floor(r%30)+1;a("now-date").innerText=`${o} ${t} ${e}`}function ne(r){let e=we(r);return e<50?ye(Math.min(e+50,100)):ye(Math.max(e-50,0))}var A=class{static id;get mytype(){return this.constructor}get typename(){return this.mytype.id}toJSON(){return{t:this.typename}}static fromJSON(e,t){return new e}};function se(r){let e=f[r.t];return e.fromJSON(e,r)}var f={};function m(r,e){f[e]=r,r.id=e}var F=class extends A{static symbol;toText(){return`${this.mytype.symbol||""} ${this.typename}`}};function Z(r){return r.prototype instanceof F}var ae=class extends F{},D=class extends ae{static symbol="\u{1F680}"};m(D,"Rocket");var P=class extends ae{static symbol="\u{1F6E2}\uFE0F"};m(P,"Fuel");var J=class extends F{};var N=class extends J{static color="blue";static symbol="\u{1F4A7}\uFE0F"};m(N,"Water");var $=class extends J{static color="yellow";static symbol="\uFE0F\u26CF\uFE0F"};m($,"Iron");var z=class extends J{static color="green";static symbol="\uFE0F\u{1F96B}"};m(z,"Food");var q=class extends J{static color="red";static symbol="\uFE0F\u2622\uFE0F"};m(q,"Radioactives");var M=class extends F{static symbol="\uFE0F\u{1F4E6}\uFE0F";from;to;total;toText(){return`${this.mytype.symbol||""} ${this.typename} to <b>${this.to}</b> planet`}toJSON(){return{t:this.typename,f:this.from,to:this.to,tot:this.total}}static fromJSON(e,t){let o=new e;return o.from=t.f,o.to=t.to,o.total=t.tot,o}};m(M,"MissionBox");function le(r){return r instanceof M}var de=["000000","2f4f4f","556b2f","8b4513","8b0000","808000","483d8b","5f9ea0","008000","3cb371","4682b4","d2691e","9acd32","cd5c5c","00008b","32cd32","daa520","8fbc8f","800080","b03060","ff0000","00ced1","ff8c00","ffd700","ffff00","0000cd","deb887","00ff00","00fa9a","8a2be2","dc143c","00bfff","adff2f","ff6347","da70d6","b0c4de","ff00ff","f0e68c","6495ed","dda0dd","ff1493","7b68ee","ffa07a","afeeee","98fb98","7fffd4","fafad2","ff69b4","ffb6c1","fff0f5"];function Ae(r,e){let t=Math.hypot(r,e);return[r/t,e/t]}function Fe(r,e){return r[0]*e[0]+r[1]*e[1]}function Je(r,e,t){let o=Ae(r.x-e.x,r.y-e.y),i=Fe(o,[t.x-e.x,t.y-e.y]);return[e.x+o[0]*i,e.y+o[1]*i]}function ge(r,e,t,o){let[i,n]=Je(r,e,t);return i>=Math.min(r.x,e.x)&&i<=Math.max(r.x,e.x)&&n>=Math.min(r.y,e.y)&&n<=Math.max(r.y,e.y)&&Math.hypot(i-t.x,n-t.y)<o}var h=50,u=5;function $e(r,e,t,o,i,n){r.beginPath(),o.isAlien?r.rect(e*h,t*h+u,h,h-2*u):r.rect(e*h+u,t*h,h-2*u,h),r.lineWidth=5,r.strokeStyle=o.color,r.fillStyle=o.color2,r.fill(),r.stroke(),r.textBaseline="top",r.fillStyle=o.color,r.fillText(i.cellName||"",e*h+u+5,t*h+5);let p=i.typename[0];i instanceof T&&(p+="C"),i instanceof L&&(p+="l"),r.fillText(p,e*h+u+5,t*h+5+16),n[e][t]={canBeHere:!0,canGoX:o.isAlien,canGoY:!o.isAlien,ship:o,component:i}}function Ye(r,e,t,o,i){let n=o.passage;r.beginPath(),r.rect((e+n.x)*h,(t+n.y)*h,n.w*h,n.h*h),r.strokeStyle=o.color,r.fillStyle=o.color2,r.fill(),r.stroke();let l=new U;for(let p=0;p<n.w;p++)for(let c=0;c<n.h;c++)i[p+e][c+t]={canBeHere:!0,canGoX:!0,canGoY:!0,ship:o,component:l}}function be(r,e,t,o,i,n){let l=r.createLinearGradient(e*h+u,t*h,e*h+u,(t+1)*h),p=r.createLinearGradient(e*h+u,t*h,e*h+u,(t+1)*h);l.addColorStop(0,o.color),l.addColorStop(1,i.color),p.addColorStop(0,o.color2),p.addColorStop(1,i.color2),r.strokeStyle=l,r.fillStyle=p,r.beginPath(),r.moveTo(e*h+u,t*h),r.lineTo(e*h+u*2,(t+.5)*h),r.lineTo(e*h+u,(t+1)*h),r.lineTo((e+1)*h-u,(t+1)*h),r.lineTo((e+1)*h-u*2,(t+.5)*h),r.lineTo((e+1)*h-u,t*h),r.closePath(),r.fill(),r.stroke(),n[e][t]={canBeHere:!0,canGoY:!0,component:new K}}function pe(r,e,t,o,i){for(let n=0;n<o.rows.length;n++)for(let l=0;l<o.rows[n].length;l++){let p=o.rows[n][l],c=o.rowToXY(n,l);p.cellName=String.fromCharCode(65+n)+c.y,$e(r,e+c.x,t-c.y,o,p,i)}Ye(r,e,t,o,i)}function Ie(r,e,t,o){let i=e.x*t,n=e.y*t;if(r.fillStyle=e.color,r.fillRect(i-1,n-1,3,3),o!==void 0&&e instanceof S)for(let l=1;l<=o;l++)r.beginPath(),r.arc(i,n,t*l,0,7),r.strokeStyle="red",r.stroke()}function V(r,e,t,o,i){o===void 0&&(o=e.x*t),i===void 0&&(i=e.y*t);var n=r.createRadialGradient(o-1,i-1,2,o,i,.2*t);n.addColorStop(0,e.color_in),n.addColorStop(1,e.color_out),r.fillStyle=n,r.beginPath(),r.arc(o,i,.2*t,0,7),r.fill()}function ve(r,e){let t=r.canvas.width,o=t/e.size,i=t/2;if(r.clearRect(0,0,t,t),e.bright){let n=r.createRadialGradient(i,i,0,i,i,o/2);n.addColorStop(0,"white"),n.addColorStop(.5,e.color),n.addColorStop(1,"transparent"),r.fillStyle=n,r.fillRect(0,0,t,t)}else{let n=r.createRadialGradient(i,i,10,i,i,o/2);n.addColorStop(0,e.color),n.addColorStop(1,"transparent"),r.fillStyle=n,r.fillRect(0,0,t,t)}for(let n of e.planets)V(r,n,o)}function Me(r,e,t){let o=r.canvas.width,i=o/s.star.size;r.clearRect(0,0,o,o);for(let n of e)(n instanceof S||n.seenBy(s.playerShip,t))&&Ie(r,n,i,t)}var Q=class extends A{cellName="";ship;onEnter(e){}};function Te(r){return r.prototype instanceof Q}var Y=class extends Q{},K=class extends Y{onEnter(e){a("Airlock_Locked").style.display=e.playerShip.toPlanet==e.playerShip.onPlanet?"":"none",a("Airlock_UnLocked").style.display=e.playerShip.toPlanet==e.playerShip.onPlanet?"none":"",a("Airlock_Detach").onclick=()=>{e.depart()}}};m(K,"Airlock");var U=class extends Y{};m(U,"Passage");var x=class extends Y{opposite="";onEnter(e){document.querySelector("#Ballast b").innerText=this.opposite||""}};m(x,"Ballast");var Ce=class r extends Y{original="";toJSON(){return{t:this.typename,o:this.original}}static fromJSON(e,t){let o=new r;return o.original=t.o,o}};m(Ce,"Debris");var E=class extends Q{};function I(r){return r.prototype instanceof E&&!(r.prototype instanceof T)}var R=class r extends E{cargo=[];toJSON(){return{t:this.typename,c:this.cargo.map(e=>e.toJSON())}}static fromJSON(e,t){let o=new r;return o.cargo=t.c.map(i=>se(i)),o}onEnter(e){document.querySelector("#CargoBay ul").innerHTML=this.cargo.map(t=>`<li>${t.toText()}</li>`).join(""),document.getElementById("CargoBay_Empty").style.display=this.cargo.length==0?"":"none",document.getElementById("CargoBay_NonEmpty").style.display=this.cargo.length==0?"none":""}};m(R,"CargoBay");function _(r){return r instanceof R}var j=class extends E{onEnter(e){let o=document.querySelector("#Radar canvas").getContext("2d");_e()}};m(j,"Radar");function _e(r){let e=a("shipsCanvas");if(e.offsetParent===null)return;let t=e.getContext("2d");s.tick(r)&&window.requestAnimationFrame(_e);let o=s.walker.map[s.walker.x][s.walker.y].ship;o!==void 0&&Me(t,s.star.ships,o.componentTypes[j.id])}var L=class extends E{};m(L,"Cloak");var T=class extends E{};function Be(r){return r.prototype instanceof T&&!(r.prototype instanceof ce)}var ee=class extends T{planetTr(e){let t=e.planet,o=e.i,i=Math.ceil(t.distanceTo(s.playerShip)/.1),n=t==s.playerShip.toPlanet?"checked":"",l=t==s.playerShip.onPlanet?"disabled":"";return`<tr><td>
            <label for="NavigationComputer_to_${o}"><canvas id="NavigationComputer_canvas_${o}" width=30 height=30></canvas></label>
        </td><td>
            <label><input type="radio" name="NavigationComputer_to" value="${o}" id="NavigationComputer_to_${o}" ${l} ${n}>
            <b>${t.name}</b> (${i}d)<br>
            ${t.buys?`wants: ${t.buys.id}`:""} ${t.sells?`gives: ${t.sells.id}`:""}
        </label></td></tr>`}showDiv(e){a("currentComponentPage").innerHTML=`#NavigationComputer_${e}{display:block !important}`}onEnter(e){if(e.timeFlies){this.showDiv("Flying");return}this.showDiv("Select"),document.querySelector("#NavigationComputer table").innerHTML=e.star.planets.map((t,o)=>({planet:t,i:o,dist:t.distanceTo(e.playerShip)})).sort((t,o)=>t.dist-o.dist).map(this.planetTr).join(""),e.star.planets.forEach((t,o)=>{let i=document.getElementById(`NavigationComputer_canvas_${o}`);if(!i)return;let n=i.getContext("2d");V(n,t,i.width/.2/2,i.width/2,i.height/2)}),a("NavigationComputer_Plot").style.display=this.ship instanceof S?"none":"",a("NavigationComputer_Fly").style.display=this.ship instanceof S?"":"none",a("NavigationComputer_Plot").onclick=()=>{let t=document.querySelector('input[name="NavigationComputer_to"]:checked');return!t||!e.playerShip.onPlanet?!1:(e.playerShip.planTrip(e.playerShip.onPlanet,e.star.planets[parseInt(t.value)],e.now),this.showDiv("Detach"),!0)},a("NavigationComputer_Fly").onclick=()=>{if(!a("NavigationComputer_Plot")?.onclick?.())return!1;this.showDiv("Departed"),e.depart()}}};m(ee,"NavigationComputer");var te=class extends T{showDiv(e){a("currentComponentPage").innerHTML=`#TradingComputer_${e}{display:block !important}`}onEnter(e){let t=e.playerShip.onPlanet;if(t===null){this.showDiv("None");return}if(e.playerShip.countCargo(),t.buys===null){let i=Math.min(e.playerShip.freeCargo,t.ratio);if(i==0){this.showDiv("NoGift");return}this.showDiv("Gift"),a("TradingComputer_gift_number").innerText=i.toString(),a("TradingComputer_gift_type").innerText=t.sells.id,a("TradingComputer_gift_take").onclick=()=>{e.playerShip.putCargo(t.sells,i),this.showDiv("Done")};return}if(e.playerShip.cargoTypes[t.buys.id]<1){this.showDiv("NothingToTradde");return}this.showDiv("Trade");let o=a("TradingComputer_give_slider");a("TradingComputer_give_type").innerText=t.buys.id,a("TradingComputer_get_type").innerText=t.sells.id,o.value=o.max=e.playerShip.cargoTypes[t.buys.id].toString(),o.style.display=e.playerShip.cargoTypes[t.buys.id]==1?"none":"",o.onchange=()=>{let i=parseInt(o.value),n=Math.round(i*t.ratio);a("TradingComputer_max_cargo_warning").style.display=n-i>e.playerShip.freeCargo?"":"none",n=Math.min(n,e.playerShip.freeCargo+i),a("TradingComputer_give_number").innerText=i.toString(),a("TradingComputer_get_number").innerText=n.toString()},o.onchange(),a("TradingComputer_deal").onclick=()=>{let i=parseInt(o.value),n=Math.round(i*t.ratio);n=Math.min(n,e.playerShip.freeCargo+i),e.playerShip.getCargo(t.buys,i),e.playerShip.putCargo(t.sells,n),this.showDiv("Done")}}};m(te,"TradingComputer");var ce=class extends T{},oe=class extends ce{missionBoxesToHere;deliveryMissionGivesBoxes;deliveryMissionGivesFreeCargoBay;divsShown=["",""];showDiv(e,t){this.divsShown[e]=t,a("currentComponentPage").innerHTML=this.divsShown.map((o,i)=>`#MissionComputer_${i}_${o}{display:block !important}`).join("")}fillRowSelectButtons(e,t){let o=k(s.playerShip.rows.length+1);o.unshift(-1),a(e).innerHTML=o.map(i=>`<button id="${e}_${i+1}">row ${String.fromCharCode(65+i)}</button>`).join(" "),o.forEach(i=>a(`${e}_${i+1}`).onclick=()=>{t(i,this)})}onEnter(e){let t=e.playerShip.onPlanet;if(!t)return;e.playerShip.countCargo();let o=e.playerShip.rows.flat().filter(_),i=[];for(let l of o)i=i.concat(l.cargo.filter(le));let n=i.filter(l=>l.from===t.name);if(this.missionBoxesToHere=i.filter(l=>l.to===t.name),this.missionBoxesToHere.length){this.showDiv(0,"Complete");let l=Math.max(1,Math.floor(this.missionBoxesToHere.length/2));a("MissionComputer_Complete_resource").innerText=`${l} ${t.sells.id}`,a("MissionComputer_Complete_cargo").innerText=[t.deliveryMissionRockets?`${t.deliveryMissionRockets} Rockets`:"",t.deliveryMissionFuel?`${t.deliveryMissionFuel} Fuel`:""].filter(c=>!!c).join(" and "),a("MissionComputer_Complete_resource").onclick=()=>{e.playerShip.getMissionBox(t.name,this.missionBoxesToHere.length),e.playerShip.putCargo(t.sells,l),this.showDiv(0,"Completed")},a("MissionComputer_Complete_cargo").onclick=()=>{e.playerShip.getMissionBox(t.name,this.missionBoxesToHere.length),e.playerShip.putCargo(D,t.deliveryMissionRockets),e.playerShip.putCargo(P,t.deliveryMissionFuel),this.showDiv(0,"Completed")};let p=this.missionBoxesToHere.every(c=>c.total==this.missionBoxesToHere[0].total&&c.from==this.missionBoxesToHere[0].from)&&this.missionBoxesToHere[0].total==this.missionBoxesToHere.length;a("MissionComputer_Complete_component_wrap").style.display=p?"":"none",a("MissionComputer_Complete_component_name").innerText=t.deliveryMissionComponent.id,this.fillRowSelectButtons("MissionComputer_Complete_component_select",this.deliveryMissionCompleteSelect)}else if(n.length){this.showDiv(0,"InProgress");let l=n.map(c=>c.to),p=[...new Set(l)];a("MissionComputer_InProgress_to").innerText=p.join(", ")}else e.playerShip.freeCargo<4&&e.playerShip.componentTypes[R.id]>=4?this.showDiv(0,"NoSpace"):(this.showDiv(0,"Offer"),this.deliveryMissionGivesFreeCargoBay=e.playerShip.freeCargo<4,this.deliveryMissionGivesFreeCargoBay?this.deliveryMissionGivesBoxes=4:this.deliveryMissionGivesBoxes=Math.max(1,Math.floor(e.playerShip.freeCargo/5))*4,a("MissionComputer_Offer_n").innerText=this.deliveryMissionGivesBoxes.toString(),a("MissionComputer_Offer_to").innerText=t.deliveryMissionDest,a("MissionComputer_Offer_CargoBay").style.display=this.deliveryMissionGivesFreeCargoBay?"":"none",a("MissionComputer_Offer_NoCargoBay").style.display=this.deliveryMissionGivesFreeCargoBay?"none":"",a("MissionComputer_Offer_accept").onclick=()=>{e.playerShip.putMissionBox(t.name,t.deliveryMissionDest,this.deliveryMissionGivesBoxes),this.showDiv(0,"Started")},this.fillRowSelectButtons("MissionComputer_Offer_CargoBay_select",this.deliveryMissionFreeCargoBaySelect));t.buys?(this.showDiv(1,"Cargo"),a("MissionComputer_Cargo_n").innerText=20 .toString(),a("MissionComputer_Cargo_name").innerText=t.buys.id,a("MissionComputer_Cargo_deliver").style.display=e.playerShip.cargoTypes[t.buys.id]>=20?"":"none",a("MissionComputer_Cargo_component_name").innerText=t.cargoMissionComponent.id,this.fillRowSelectButtons("MissionComputer_Cargo_component_select",this.cargoMissionSelect)):this.showDiv(1,"None")}deliveryMissionFreeCargoBaySelect(e,t){let o=s.playerShip.onPlanet;o&&(s.playerShip.deBallastTail(),s.playerShip.addComponent(new R,e),s.playerShip.balanceBallast(),s.playerShip.countComponents(),s.playerShip.countCargo(),s.playerShip.putMissionBox(o.name,o.deliveryMissionDest,t.deliveryMissionGivesBoxes),s.walker.reattach(),t.showDiv(0,"Started"))}deliveryMissionCompleteSelect(e,t){let o=s.playerShip.onPlanet;if(!o)return;s.playerShip.deBallastTail(),s.playerShip.addComponent(new o.deliveryMissionComponent,e),s.playerShip.balanceBallast(),s.playerShip.countComponents(),s.playerShip.countCargo(),s.playerShip.getMissionBox(o.name,t.missionBoxesToHere.length),s.walker.reattach(),t.showDiv(0,"Completed");let i=Object.values(f).filter(I);o.cargoMissionComponent=g(i)}cargoMissionSelect(e,t){let o=s.playerShip.onPlanet;if(!o?.buys)return;s.playerShip.deBallastTail(),s.playerShip.addComponent(new o.cargoMissionComponent,e),s.playerShip.balanceBallast(),s.playerShip.countComponents(),s.playerShip.countCargo(),s.playerShip.getCargo(o.buys,20),s.walker.reattach(),t.showDiv(1,"Completed");let i=Object.values(f).filter(I);o.cargoMissionComponent=g(i)}};m(oe,"MissionComputer");var w=class r{name;color;color2;isAlien=!1;rows=[];offsets=[];componentTypes;cargoTypes;freeCargo;isPlayerShip=!1;playerOnShip=!1;playerX;playerY;x;y;fromPoint;toPlanet;fromTime;toTime;updateSpaceXY(e,t=!0){for(;e>=this.toTime&&t;)this.toPlanet.dispatch(this,this.toTime);let o=(e-this.fromTime)/(this.toTime-this.fromTime);this.x=this.fromPoint.x+(this.toPlanet.x-this.fromPoint.x)*o,this.y=this.fromPoint.y+(this.toPlanet.y-this.fromPoint.y)*o}planTrip(e,t,o){this.fromPoint=e,this.toPlanet=t,this.fromTime=o;let n=t.distanceTo(e)/.1;this.toTime=o+n,this.updateSpaceXY(this.fromTime)}countComponents(){this.componentTypes={};let e=Object.values(f).filter(Te).forEach(o=>this.componentTypes[o.id]=0),t=this.rows.flat();for(let o of t)this.componentTypes[o.typename]++}countCargo(){let e=this.rows.flat().filter(_);this.freeCargo=0,this.cargoTypes={},Object.values(f).filter(Z).forEach(t=>this.cargoTypes[t.id]=0);for(let t of e){this.freeCargo+=5-t.cargo.length;for(let o of t.cargo)this.cargoTypes[o.typename]++}}addComponent(e,t){e.ship=this,t<0&&(this.rows.unshift([]),this.rows.push([]),this.offsets.unshift(0),this.offsets.push(0),t=0),t>=this.rows.length&&(this.rows.unshift([]),this.rows.push([]),this.offsets.unshift(0),this.offsets.push(0),t=this.rows.length-1),this.rows[t].push(e)}getCargo(e,t){if(t>this.cargoTypes[e.id])return!1;this.cargoTypes[e.id]-=t,this.freeCargo+=t;let o=this.rows.flat().filter(_).filter(i=>i.cargo.length);for(let i of o)if(i.cargo=i.cargo.filter(n=>!(n instanceof e&&t-- >0)),t<=0)return!0}getMissionBox(e,t){if(t>this.cargoTypes[M.id])return!1;this.cargoTypes[M.id]-=t,this.freeCargo+=t;let o=this.rows.flat().filter(_).filter(i=>i.cargo.length);for(let i of o)if(i.cargo=i.cargo.filter(n=>!(n instanceof M&&n.to==e&&t-- >0)),t<=0)return!0}putCargo(e,t){if(t>this.freeCargo)return!1;this.cargoTypes[e.id]+=t,this.freeCargo-=t;let o=this.rows.flat().filter(_).filter(i=>i.cargo.length<5);for(let i of o){for(;t>0&&i.cargo.length<5;)i.cargo.push(new e),t--;if(t<=0)return!0}}putMissionBox(e,t,o){if(o>this.freeCargo)return!1;this.cargoTypes[M.id]+=o,this.freeCargo-=o;let i=this.rows.flat().filter(_).filter(l=>l.cargo.length<5),n=o;for(let l of i){for(;n>0&&l.cargo.length<5;){let p=new M;p.from=e,p.to=t,p.total=o,l.cargo.push(p),n--}if(n<=0)return!0}}seenBy(e,t){let o=Math.hypot(e.x-this.x,e.y-this.y);return t>=o+this.componentTypes[L.id]}toJSON(){return{a:this.isAlien,n:this.name,c:this.color,o:this.offsets,r:this.rows.map(e=>e.map(t=>t.toJSON())),frX:this.fromPoint?.x,frY:this.fromPoint?.y,frT:this.fromTime,toP:this.toPlanet?.i,toT:this.toTime}}static fromJSON(e,t,o){o||(o=new r),o.isAlien=e.a,o.name=e.n,o.color=e.c,o.color2="#"+ne(e.c.substr(1)),o.offsets=e.o,o.rows=[];for(let i=0;i<e.r.length;i++){o.rows[i]=[];for(let n=0;n<e.r[i].length;n++)o.addComponent(se(e.r[i][n]),i)}return o.fromPoint={x:e.frX,y:e.frY},o.fromTime=e.frT,o.toTime=e.toT,t&&(o.toPlanet=t.planets[e.toP]),o.fillBallastOpposite(),o.countComponents(),o}get gridSize(){if(this.isAlien)return{x0:0,x1:0,y0:0,y1:0,w:0,h:0};{let e=0,t=0;for(let o=0;o<this.rows.length;o++)e=Math.max(e,this.rows[o].length-this.offsets[o]),t=Math.max(t,this.offsets[o]);return{x0:0,x1:this.rows.length-1,y0:e,y1:t,w:this.rows.length,h:e+t+1}}}rowToXY(e,t){return this.isAlien?{x:0,y:0}:t>=this.offsets[e]?{x:e,y:1+(t-this.offsets[e])}:{x:e,y:t-this.offsets[e]}}get passage(){return this.isAlien?{x:0,y:0,w:0,h:0}:{x:0,y:0,w:this.rows.length,h:1}}oppositeComponent(e){for(let t=0;t<=this.rows.length;t++){let o=this.rows[t].indexOf(e);if(o>=0)return this.rows[this.rows.length-1-t][o]}}static randomShip(e,t){let i=Object.values(f).filter(I),n=Object.values(f).filter(Be),l=i.concat(n),p=Object.values(f).filter(Z);t===void 0&&(t=new r);let c=g(de);t.color="#"+c,t.color2="#"+ne(c),t.rows=[[],[],[],[]],t.offsets=[0,0,0,0];for(let C=0;C<e;C++){let d=g(l),v=new d;if(v instanceof R){let W=b(0,5);for(let xe=0;xe<W;xe++){let He=g(p);v.cargo.push(new He)}}t.addComponent(v,b(0,3))}for(let C=0;C<t.rows.length;C++)t.offsets[C]=b(0,t.rows[C].length);return t.balanceBallast(),t.countComponents(),t}static newBase(){let e=new r,t=g(de);e.color="#"+t,e.color2="#"+ne(t),e.rows=[[],[]];let o=B([new ee,new j,new te,new oe]);for(let i of o)e.addComponent(i,b(0,1));return e.offsets=[b(0,e.rows[0].length),b(0,e.rows[1].length)],e.balanceBallast(),e.countComponents(),e}deBallastTail(){if(!this.isAlien){let t=this.rows.length-1;for(var e=0;e<=t;e++)for(;this.rows[e].at(-1)instanceof x;)this.rows[e].pop()}}balanceBallast(){if(!this.isAlien){let t=this.rows.length-1;for(var e=0;e<=t;e++)for(;this.offsets[e]<this.offsets[t-e];)this.rows[e].unshift(new x),this.offsets[e]++;for(var e=0;e<=t;e++)for(;this.rows[e].length<this.rows[t-e].length;)this.rows[e].push(new x);for(var e=0;e<=t;e++)for(;this.rows[e][0]instanceof x&&this.rows[t-e][0]instanceof x;)this.rows[e].shift(),this.rows[t-e].shift(),this.offsets[e]--,this.offsets[t-e]++;for(var e=0;e<=t;e++)for(;this.rows[e].at(-1)instanceof x&&this.rows[t-e].at(-1)instanceof x;)this.rows[e].pop(),this.rows[t-e].pop()}this.fillBallastOpposite()}fillBallastOpposite(){if(!this.isAlien){let o=this.rows.length-1;for(var e=0;e<=o;e++)for(var t=0;t<=this.rows[e].length;t++)this.rows[e][t]instanceof x&&(this.rows[e][t].opposite=this.rows[o-e][t].typename)}}get topAirlock(){if(this.isAlien)return 0;{let e=0;for(let t=0;t<this.rows.length;t++)e=Math.max(e,this.rows[t].length-this.offsets[t]);for(let t=0;t<this.rows.length;t++)if(this.rows[t].length-this.offsets[t]==e)return t;return 0}}get bottomAirlock(){if(this.isAlien)return 0;{let e=Math.max(...this.offsets);return this.offsets.lastIndexOf(e)}}};var ke=function(){let r=[N,$,z,q];for(var e=[[null,"water-mining","farming","burning"],["ice",null,"hunting","fire"],["fishy","bio-mining",null,"nuclear"],["frozen","hot mining","ice-farming",null]],t=[["ocean",null,N,"navy","blue"],["desert",N,P,"blue","purple"],["factory",$,D,"yellow","orange"],["war",D,P,"orange","purple"]],o=0;o<4;o++)for(var i=0;i<4;i++)o!=i&&t.push([e[o][i],r[o],r[i],r[o].color,r[i].color]);return t}(),me=class r{x;y;i;type;name;buys;sells;ratio;color_in;color_out;neighbours;base;deliveryMissionDest;deliveryMissionComponent;deliveryMissionRockets;deliveryMissionFuel;cargoMissionComponent;constructor(e){var t=ke[e];this.type=e,this.name=t[0],this.buys=t[1],this.sells=t[2],this.color_in=t[3],this.color_out=t[4]}distanceTo(e){return Math.hypot(this.x-e.x,this.y-e.y)}toJSON(){return{x:this.x,y:this.y,tp:this.type,b:this.base.toJSON(),dd:this.deliveryMissionDest,dc:this.deliveryMissionComponent?.id,dr:this.deliveryMissionRockets,df:this.deliveryMissionFuel,cc:this.cargoMissionComponent?.id}}static fromJSON(e){let t=new r(e.tp);return t.x=e.x,t.y=e.y,e.b?t.base=w.fromJSON(e.b):t.base=w.newBase(),e.dd&&(t.deliveryMissionDest=e.dd),e.dc&&(t.deliveryMissionComponent=f[e.dc]),e.dr&&(t.deliveryMissionRockets=e.dr),e.df&&(t.deliveryMissionFuel=e.df),e.cc&&(t.cargoMissionComponent=f[e.cc]),t}dispatch(e,t){let o=this.neighbours.shift();this.neighbours.push(o),e.planTrip(this,o,t)}onEnter(){this.deliveryMissionDest=g(this.neighbours).name;let e=Object.values(f).filter(I);this.cargoMissionComponent=g(e),this.deliveryMissionComponent=g(e);let t=s.playerShip.rows.flat().filter(_),o=[];for(let n of t)o=o.concat(n.cargo.filter(le));let i=o.filter(n=>n.to===this.name);if(i.length){let n=Math.max(1,Math.floor(i.length/2));this.deliveryMissionRockets=b(0,n),this.deliveryMissionFuel=n-this.deliveryMissionRockets}}};function Xe(r,e,t){var o=t/2;return r<o+.6&&r>o-.6&&e<o+.6&&e>o-.6}function De(r){for(var e=B(k(ke.length)),t=0;t<100;t++){for(var o=!1,i=[],n=B(k(r)),l=B(k(r)),p=r/2,c=0;c<r;c++)Xe(n[c]+.5,l[c]+.5,r)&&(o=!0),i.push({x:n[c]+.5,y:l[c]+.5,tp:e[c]});if(!o)return i}return console.error("should not be here"),[]}var We=["AliceBlue","AntiqueWhite","Aqua","Aquamarine","Azure","Beige","Bisque","BlanchedAlmond","Blue","BlueViolet","Brown","BurlyWood","CadetBlue","Chartreuse","Chocolate","Coral","CornflowerBlue","Cornsilk","Crimson","Cyan","DarkGray","DarkGrey","DarkKhaki","DarkOrange","DarkOrchid","DarkSalmon","DarkSeaGreen","DarkTurquoise","DarkViolet","DeepPink","DeepSkyBlue","DimGray","DodgerBlue","FireBrick","FloralWhite","Fuchsia","Gainsboro","GhostWhite","Gold","Goldenrod","Gray","GreenYellow","Grey","Honeydew","HotPink","IndianRed","Ivory","Khaki","Lavender","LavenderBlush","LawnGreen","LemonChiffon","LightBlue","LightCoral","LightCyan","LightGoldenrodYellow","LightGray","LightGreen","LightGrey","LightPink","LightSalmon","LightSeaGreen","LightSkyBlue","LightSlateGray","LightSlateGrey","LightSteelBlue","LightYellow","Lime","LimeGreen","Linen","Magenta","MediumAquamarine","MediumBlue","MediumOrchid","MediumPurple","MediumSeaGreen","MediumSlateBlue","MediumSpringGreen","MediumTurquoise","MediumVioletRed","MintCream","MistyRose","Moccasin","NavajoWhite","OldLace","Orange","OrangeRed","Orchid","PaleGoldenrod","PaleGreen","PaleTurquoise","PaleVioletRed","PapayaWhip","PeachPuff","Peru","Pink","Plum","PowderBlue","Red","RosyBrown","RoyalBlue","Salmon","SandyBrown","Seashell","Sienna","Silver","SkyBlue","SlateBlue","SlateGray","SlateGrey","Snow","SpringGreen","SteelBlue","Tan","Thistle","Tomato","Turquoise","Violet","Wheat","White","WhiteSmoke","Yellow","YellowGreen"];function ze(r,e){for(var t=k(e).map(l=>[]),o=(e-1)/2,i=Math.floor(o);i<=Math.ceil(o);i++)for(var n=Math.floor(o);n<=Math.ceil(o);n++)t[i+1][n+1]=r;return t}var X=class{color;size;bright;name;grid;planets;ships;constructor(e){e||(e={c:g(We),sz:b(5,9),p:!1,sh:!1}),this.color=e.c,this.size=e.sz,this.bright=!1,this.name=this.color,this.size%2==0&&(this.bright=!0,this.name="bright "+this.name),this.grid=ze(this,this.size),e.p||(e.p=De(this.size)),this.planets=e.p.map(t=>me.fromJSON(t));for(let t=0;t<this.planets.length;t++){let o=this.planets[t];o.i=t,o.neighbours=B(this.planets.filter(i=>i!=o&&!this.pathCollides(i,o))),this.grid[Math.floor(o.x)][Math.floor(o.y)]=o}e.sh&&(this.ships=e.sh.map(t=>t.p?S.fromJSON(t,this):w.fromJSON(t,this))),this.setRatios()}pathCollides(e,t){if(ge(e,t,{x:this.size/2,y:this.size/2},.5))return!0;for(var o of this.planets)if(o!=e&&o!=t&&ge(e,t,o,.2))return!0;return!1}computeRareResources(e){e===void 0&&(e=this.planets);let t=e.map(n=>n.sells),o=Object.values(f).filter(Z).filter(n=>!t.includes(n)),i=e.filter(n=>n.buys===null).map(n=>n.sells);return{exotic:o,abundant:i}}setRatios(){let e=this.computeRareResources();for(let t of this.planets)t.buys===null?t.ratio=2:e.abundant.includes(t.buys)?t.ratio=1:e.exotic.includes(t.buys)?t.ratio=2:t.ratio=1.4}addRandomShips(e){this.ships=[];for(let t=0;t<this.planets.length;t++)for(let o=0;o<t;o++){if(this.planets[t].neighbours.indexOf(this.planets[o])<0)continue;let i=w.randomShip(15),l=Math.hypot(this.planets[t].x-this.planets[o].x,this.planets[t].y-this.planets[o].y)/.1;this.planets[t].dispatch(i,e-l),this.ships.push(i)}}toJSON(){return{c:this.color,sz:this.size,p:this.planets.map(e=>e.toJSON()),sh:this.ships.map(e=>e.toJSON())}}};var fe=class r{star;playerShip;walker;now=0;lastTickTimestamp;lastDate;_timeFlies=!1;tickInterval=0;get timeFlies(){return this._timeFlies}set timeFlies(e){if(this._timeFlies!=e)if(this._timeFlies=e,e){let t=this;this.lastTickTimestamp=performance.now(),this.tickInterval=setInterval(function(){t.tick()},1e3)}else clearInterval(this.tickInterval)}tick(e){if(!this._timeFlies)return!1;if(e||(e=performance.now()),e<=this.lastTickTimestamp)return!0;this.now+=Math.max(0,Math.min(e-this.lastTickTimestamp,1e3))/1e3,this.lastTickTimestamp=e;let t=Math.floor(this.now);if(this.lastDate!=t){ie(t),this.lastDate=t;let o=Math.ceil(this.playerShip.toTime-this.now);re(`Approaching ${this.playerShip.toPlanet.name} planet in ${o} days`)}for(let o of this.star.ships)o.updateSpaceXY(this.now);return!0}depart(){this.timeFlies=!0;let e=a("bgCanvas");e.getContext("2d").clearRect(0,0,e.width,e.height),this.playerShip.onPlanet=null,this.walker.detach(),this.lastDate=-1,this.tick()}arrive(e,t,o){let i=this.playerShip.toPlanet;this.playerShip.onPlanet=i,this.playerShip.x=i.x,this.playerShip.y=i.y,this.timeFlies=!1,e||i.onEnter(),re(`Docking to base at ${i.name} planet`),t||(localStorage.space2d3_2=JSON.stringify(this.toJSON()));let n=a("bgCanvas"),l=n.getContext("2d"),p=a("canvasBox");o&&n.classList.add("notransition"),n.width=p.offsetWidth,n.height=p.offsetHeight,V(l,i,n.width/.2/2,n.width/2,n.height/2),this.walker.attach(i.base),re(`Docked to base at ${i.name} planet`)}toJSON(){return{v:2,s:this.star.toJSON(),n:this.now}}static fromJSON(e){if(e?.v!=2)return!1;let t=new r;t.star=new X(e.s);let o=t.star.ships.filter(Re);return o.length!=1?!1:(t.playerShip=o[0],t.now=e.n,t)}};function Pe(r){let e=fe.fromJSON(r);return e?(s=e,!0):!1}function Oe(){s=new fe}var s;var S=class r extends w{onPlanet;updateSpaceXY(e){super.updateSpaceXY(e,!1),e>=this.toTime&&s.arrive()}static randomShip(e){let t=new r;return w.randomShip(e,t),t}toJSON(){let e=super.toJSON();return e.p=!0,this.onPlanet!=null&&(e.on=this.onPlanet.i),e}static fromJSON(e,t){let o=new r;return w.fromJSON(e,t,o),o}};function Re(r){return r instanceof S}var ue=class{x;y;map;box;human;canvas;ctx;onEnter;oneShipData;twoShipsData;hasSecondShip=!1;myShip;secondShip;newMap(e,t){this.map=[];for(let o=0;o<=e;o++){this.map[o]=[];for(let i=0;i<=t;i++)this.map[o][i]={}}}goX(e){return!this.map[this.x][this.y].canGoX||!this.map[this.x+e][this.y].canBeHere?!1:(this.x+=e,this.reposition(),this.onEnter(this.map[this.x][this.y].component),!0)}goY(e,t){return!t&&!this.map[this.x][this.y].canGoY||!this.map[this.x][this.y+e].canBeHere?!1:(this.y+=e,this.reposition(),this.onEnter(this.map[this.x][this.y].component),!0)}goUp(){this.goY(-1),this.human.style.transform="rotate(0deg)"}goDn(e){this.goY(1,e),this.human.style.transform="rotate(180deg)"}goLt(){this.goX(-1),this.human.style.transform="rotate(-90deg)"}goRt(){this.goX(1),this.human.style.transform="rotate(90deg)"}jumpTo(e,t,o=!0){this.x=e,this.y=t,this.reposition(!0),o&&this.onEnter(this.map[e][t].component)}reposition(e){e&&this.canvas.classList.add("notransition");let t=(this.x+.5)*h,i=this.box.offsetWidth/2-t;this.canvas.style.left=i+"px";let n=(this.y+.5)*h,p=this.box.offsetHeight/2-n;this.canvas.style.top=p+"px",e&&(this.canvas.offsetHeight,this.canvas.classList.remove("notransition"))}putTwoShips(e,t){let o=e.gridSize,i=t.gridSize,n=e.bottomAirlock,l=t.topAirlock,p=Math.max(n,l)+1,c=o.h+1,C=p+Math.max(o.w-n,i.w-l),d=c+i.h+1;this.myShip=t,this.secondShip=e,this.hasSecondShip=!0,this.twoShipsData={ax0:p-n+o.x0,ay0:o.y0+1,airlock_x:p,airlock_y:c,bx0:p-l+i.x0,by0:c+i.y0+1,max_x:C,max_y:d}}drawTwoShips(e,t){this.putTwoShips(e,t);let o=this.twoShipsData;this.newMap(o.max_x,o.max_y),this.ctx.canvas.width=h*(o.max_x+1),this.ctx.canvas.height=h*(o.max_y+1),pe(this.ctx,o.ax0,o.ay0,e,this.map),pe(this.ctx,o.bx0,o.by0,t,this.map),be(this.ctx,o.airlock_x,o.airlock_y,e,t,this.map)}drawMyShip(){this.hasSecondShip=!1;let e=this.oneShipData=this.myShip.gridSize;this.newMap(e.w+1,e.h+1),this.ctx.canvas.width=h*(e.w+2),this.ctx.canvas.height=h*(e.h+2),pe(this.ctx,e.x0+1,e.y0+1,this.myShip,this.map)}detach(){if(!this.hasSecondShip)return!1;let e=!1;if(this.y==this.twoShipsData.airlock_y&&(this.y++,e=!0),this.secondShip.playerOnShip=this.y<this.twoShipsData.airlock_y,this.myShip.playerOnShip=this.y>this.twoShipsData.airlock_y,!(this.y<this.twoShipsData.airlock_y)){let t=this.myShip.playerX=this.x-this.twoShipsData.bx0,o=this.myShip.playerY=this.y-this.twoShipsData.by0;this.drawMyShip(),e?(this.jumpTo(this.oneShipData.x0+1+t,this.oneShipData.y0+o,!1),this.goDn(!0)):this.jumpTo(this.oneShipData.x0+1+t,this.oneShipData.y0+1+o,!1)}}attach(e){if(this.hasSecondShip)return!1;let t=this.x-1-this.oneShipData.x0,o=this.y-1-this.oneShipData.y0;this.drawTwoShips(e,this.myShip),this.jumpTo(this.twoShipsData.bx0+t,this.twoShipsData.by0+o)}reattach(){if(!this.hasSecondShip)return!1;if(this.y>=this.twoShipsData.airlock_y)return;let e=this.secondShip.playerX=this.x-this.twoShipsData.ax0,t=this.secondShip.playerY=this.y-this.twoShipsData.ay0;this.drawTwoShips(this.secondShip,this.myShip),this.jumpTo(this.twoShipsData.ax0+e,this.twoShipsData.ay0+t)}};(location.hostname=="localhost"||location.hostname=="127.0.0.1")&&new EventSource("/esbuild").addEventListener("change",()=>location.reload());var Ge={a:!1,n:"Your Ship",c:"#5E5E5E",o:[0,0],r:[[{t:"CargoBay",c:[{t:"Water"},{t:"Food"},{t:"Iron"},{t:"Radioactives"}]}],[{t:"Ballast"}]],frX:0,frY:0,frT:-1,toP:0,toT:0,p:!0};window.matchMedia("(prefers-color-scheme: dark)").matches&&(Ge.c="#919191");var y=new ue,Ne=a("myCanvas"),qe=Ne.getContext("2d");y.box=a("canvasBox");y.human=a("human");y.canvas=Ne;y.ctx=qe;y.onEnter=Ve;window.onresize=()=>{s.walker.reposition(!0)};function Le(r){Oe(),s.star=new X,s.star.addRandomShips(0),r?s.playerShip=S.fromJSON(r,s.star):s.playerShip=S.randomShip(15),s.star.ships.push(s.playerShip),s.playerShip.planTrip({x:s.star.planets[0].x-.1,y:s.star.planets[0].y},s.star.planets[0],-1),s.now=0,Ee(!0)}function Ze(){return Pe(JSON.parse(localStorage.space2d3_2))?(Ee(),!0):!1}function Ee(r=!1){y.myShip=s.playerShip,y.drawMyShip(),y.jumpTo(y.oneShipData.x0+1,y.oneShipData.y0+1),s.walker=y,a("main").style.display="flex",s.arrive(!r,r),ie(Math.floor(s.now));let t=a("systemCanvas").getContext("2d");ve(t,s.star),window.gs=s}a("newGameEasy").onclick=()=>{Le(Ge)};a("newGameHard").onclick=()=>{Le()};localStorage.space2d3_2?Ze()||(localStorage.space2d3_2=prompt("Error loading game. Fix savegame data below or press Cancel to delete savegame and start anew",localStorage.space2d3_2)||"",location.reload()):a("newGameDialog").showModal();a("newGameButton").onclick=()=>{a("newGameCancelBox").style.display="",a("newGameDialog").showModal()};window.onkeypress=r=>{switch(r.key){case"w":y.goUp();break;case"a":y.goLt();break;case"s":y.goDn();break;case"d":y.goRt();break}};function Ve(r){r&&(a("currentComponent").innerHTML=`#${r.typename} {display:block}`,r.cellName?a("componentLegend").innerText=`${r.cellName}: ${r.typename}`:a("componentLegend").innerText=`${r.typename}`,r.onEnter(s))}})();
//# sourceMappingURL=script.js.map
